<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DS-160 · Viaje (ES) · v5</title>
  <style>
    :root{
      color-scheme: light dark;
      --bg: #f6f7fb;
      --bg-grad: radial-gradient(1200px 600px at 10% -10%, #dfe7ff55, transparent 60%),
                 radial-gradient(800px 400px at 110% 10%, #ffe6d655, transparent 60%);
      --card: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --border: #e2e8f0;
      --accent: #2563eb;
      --accent-600: #1d4ed8;
      --accent-700: #1e40af;
      --ring: #93c5fd;
      --shadow: 0 10px 30px rgba(2, 8, 23, .08);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0b1220;
        --bg-grad: radial-gradient(1200px 600px at 10% -10%, #1d2a4e75, transparent 60%),
                   radial-gradient(800px 400px at 110% 10%, #4e2a1d75, transparent 60%);
        --card: #0f172a;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --border: #233044;
        --accent: #60a5fa;
        --accent-600: #3b82f6;
        --accent-700: #2563eb;
        --ring: #60a5fa;
        --shadow: 0 12px 36px rgba(0,0,0,.35);
      }
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      line-height: 1.45;
      color: var(--text);
      background: var(--bg);
      background-image: var(--bg-grad);
    }

    .wrap { max-width: 960px; margin: 32px auto; padding: 0 16px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 24px;
      box-shadow: var(--shadow);
      backdrop-filter: saturate(120%) blur(4px);
    }

    header h1 { font-size: 1.35rem; margin: 0 0 6px; letter-spacing: -.01em; }
    .subtle { color: var(--muted); font-size: .95rem; margin-bottom: 18px; }

    fieldset {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      margin: 16px 0;
      background: linear-gradient(180deg, rgba(148,163,184,.06), transparent 60%);
    }
    legend { font-weight: 700; padding: 0 10px; font-size: .98rem; }
    legend::after{
      content: ""; display: inline-block; width: 8px; height: 8px; margin-left: 8px; border-radius: 999px;
      background: var(--accent); box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 20%, transparent);
    }

    label { display: inline-block; margin: 8px 0 6px; font-weight: 600; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .grid-2 { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
    .inline { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .inline.nowrap { flex-wrap: nowrap; }

    input[type="text"], input[type="date"], input[type="email"], input[type="tel"], select {
      width: 100%; max-width: 560px; padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text);
      outline: none; transition: border-color .15s ease, box-shadow .15s ease, transform .06s ease; box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }
    input[type="text"]:focus, input[type="date"]:focus, input[type="email"]:focus, input[type="tel"]:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px color-mix(in oklab, var(--ring) 45%, transparent); }
    select.small { max-width: 420px; }

    .help { font-size: .9rem; color: var(--muted); margin-top: 2px; }

    .actions { margin-top: 18px; display: flex; gap: 12px; align-items: center; border-top: 1px dashed var(--border); padding-top: 16px; }
    button {
      padding: 10px 16px; border-radius: 12px; border: 1px solid var(--border); background: var(--card);
      cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 600;
      transition: transform .06s ease, box-shadow .15s ease, background .2s ease, border-color .15s ease;
    }
    button.primary { background: linear-gradient(180deg, var(--accent), var(--accent-600)); color: white; border-color: transparent; box-shadow: 0 6px 16px rgba(37,99,235,.35); }
    button.primary:hover { background: linear-gradient(180deg, var(--accent-600), var(--accent-700)); transform: translateY(-0.5px); }

    .purpose-item { display:flex; gap:12px; align-items:center; }
    .purpose-item button.remove { border-color:#ef4444; color:#ef4444; }
    .purpose-item button.remove:hover{ background:#ef44441a; }

    .note { font-size:.92rem; color:var(--muted); }
    [hidden] { display: none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>Solicitud de Visa de No Inmigrante en línea (DS-160)</h1>
        <div class="subtle">Sección: <strong>Viaje</strong></div>
      </header>

      <form id="ds160-travel" action="#" method="post" novalidate>
        <fieldset>
          <legend>Información de viaje</legend>
          <p class="help">Nota: Proporcione la siguiente información sobre sus planes de viaje.</p>

          <!-- Propósito de viaje -->
          <div class="row">
            <label for="PURPOSE_0">Propósito de viaje a EE. UU.</label>
            <div id="purposeList" class="row"></div>
            <div class="inline">
              <button type="button" id="addPurposeBtn">Agregar otro propósito</button>
            </div>
          </div>

          <!-- ¿Planes específicos de viaje? -->
          <div class="row" style="margin-top:8px;">
            <label>¿Ha hecho arreglos específicos de viaje?</label>
            <div class="inline" role="radiogroup" aria-label="Planes específicos de viaje">
              <label style="font-weight:400;"><input type="radio" name="SpecificTravelPlans" value="Y" id="SpecificTravelPlansY" required> Sí</label>
              <label style="font-weight:400;"><input type="radio" name="SpecificTravelPlans" value="N" id="SpecificTravelPlansN"> No</label>
            </div>
          </div>

          <!-- Sección visible sólo si la respuesta es "Sí" -->
          <div id="specificPlansSection" class="row" hidden>
            <div class="grid-2">
              <div>
                <label for="ARRIVAL_DATE">Fecha de llegada</label>
                <input type="date" id="ARRIVAL_DATE" name="ARRIVAL_DATE">
                <p class="help">Si ya cuenta con boleto, indique la fecha exacta de llegada.</p>
              </div>
              <div>
                <label for="DEPARTURE_DATE">Fecha de salida</label>
                <input type="date" id="DEPARTURE_DATE" name="DEPARTURE_DATE">
              </div>
            </div>

            <div class="grid-2">
              <div>
                <label for="ARRIVAL_CITY">Ciudad de llegada</label>
                <input type="text" id="ARRIVAL_CITY" name="ARRIVAL_CITY" maxlength="64" placeholder="Ej. Los Ángeles">
              </div>
              <div>
                <label for="ARRIVAL_STATE">Estado de llegada (EE. UU.)</label>
                <select id="ARRIVAL_STATE" name="ARRIVAL_STATE"></select>
              </div>
            </div>

            <div class="grid-2">
              <div>
                <label for="DEPARTURE_CITY">Ciudad de salida</label>
                <input type="text" id="DEPARTURE_CITY" name="DEPARTURE_CITY" maxlength="64" placeholder="Ej. Nueva York">
              </div>
              <div>
                <label for="DEPARTURE_STATE">Estado de salida (EE. UU.)</label>
                <select id="DEPARTURE_STATE" name="DEPARTURE_STATE"></select>
              </div>
            </div>

            <div class="row">
              <label for="FLIGHT_NUMBER">Aerolínea y número de vuelo <span class="note">(opcional)</span></label>
              <input type="text" id="FLIGHT_NUMBER" name="FLIGHT_NUMBER" maxlength="32" placeholder="Ej. AA1234">
            </div>

            <fieldset>
              <legend>Dirección donde se hospedará</legend>
              <div class="row">
                <label for="STAY_ADDR1">Dirección (línea 1)</label>
                <input type="text" id="STAY_ADDR1" name="STAY_ADDR1" maxlength="120" autocomplete="address-line1">
              </div>
              <div class="row">
                <label for="STAY_ADDR2">Dirección (línea 2) <span class="note">(opcional)</span></label>
                <input type="text" id="STAY_ADDR2" name="STAY_ADDR2" maxlength="120" autocomplete="address-line2">
              </div>
              <div class="grid-2">
                <div>
                  <label for="STAY_CITY">Ciudad</label>
                  <input type="text" id="STAY_CITY" name="STAY_CITY" maxlength="64" autocomplete="address-level2">
                </div>
                <div>
                  <label for="STAY_STATE">Estado (EE. UU.)</label>
                  <select id="STAY_STATE" name="STAY_STATE"></select>
                </div>
              </div>
              <div class="row" style="max-width:260px;">
                <label for="STAY_ZIP">Código postal</label>
                <input type="text" id="STAY_ZIP" name="STAY_ZIP" inputmode="numeric" maxlength="10" placeholder="##### o #####-####" autocomplete="postal-code">
              </div>
            </fieldset>
          </div>
        </fieldset>

        <fieldset>
          <legend>Pagos del viaje</legend>
          <div class="row">
            <label for="PAYER">Persona/entidad que paga su viaje</label>
            <select id="PAYER" name="PAYER" required class="small" aria-label="Persona o entidad que paga su viaje">
              <option value="">- Seleccione -</option>
              <option value="S">Yo mismo/a</option>
              <option value="H">Peticionario en EE. UU.</option>
              <option value="O">Otra persona</option>
              <option value="P">Empleador actual</option>
              <option value="U">Empleador en EE. UU.</option>
              <option value="C">Otra empresa/organización</option>
            </select>
          </div>

          <!-- Campos dependientes según pagador -->
          <div id="payerFields" class="row" hidden>
            <!-- Para personas (H, O) -->
            <div id="payerPersonFields" class="row" hidden>
              <div class="grid-2">
                <div>
                  <label for="PAYER_SURNAME">Apellido(s) del pagador</label>
                  <input type="text" id="PAYER_SURNAME" name="PAYER_SURNAME" maxlength="60" placeholder="Ej. García López">
                </div>
                <div>
                  <label for="PAYER_GIVEN">Nombre(s) del pagador</label>
                  <input type="text" id="PAYER_GIVEN" name="PAYER_GIVEN" maxlength="60" placeholder="Ej. María Fernanda">
                </div>
              </div>
              <div class="grid-2">
                <div>
                  <label for="PAYER_REL">Relación con usted</label>
                  <select id="PAYER_REL" name="PAYER_REL">
                    <option value="">- Seleccione -</option>
                    <option value="SPOUSE">Esposo/a</option>
                    <option value="PARENT">Padre/Madre</option>
                    <option value="CHILD">Hijo/a</option>
                    <option value="SIBLING">Hermano/a</option>
                    <option value="OTHERREL">Otro familiar</option>
                    <option value="FRIEND">Amigo/a</option>
                    <option value="EMPLOYER">Empleador</option>
                    <option value="OTHER">Otro</option>
                  </select>
                </div>
                <div>
                  <label for="PAYER_PHONE">Teléfono del pagador</label>
                  <input type="tel" id="PAYER_PHONE" name="PAYER_PHONE" maxlength="25" placeholder="+52 55 1234 5678">
                </div>
              </div>
              <div class="row" style="max-width:560px;">
                <label for="PAYER_EMAIL">Correo electrónico del pagador</label>
                <input type="email" id="PAYER_EMAIL" name="PAYER_EMAIL" maxlength="100" placeholder="nombre@correo.com">
              </div>
            </div>

            <!-- Para empresas/organizaciones (P, U, C) -->
            <div id="payerOrgFields" class="row" hidden>
              <div class="row">
                <label for="ORG_NAME">Nombre de la empresa/organización</label>
                <input type="text" id="ORG_NAME" name="ORG_NAME" maxlength="120" placeholder="Ej. Industrias Ejemplo S.A. de C.V.">
              </div>
              <div class="grid-2">
                <div>
                  <label for="ORG_PHONE">Teléfono</label>
                  <input type="tel" id="ORG_PHONE" name="ORG_PHONE" maxlength="25" placeholder="+1 212 555 0199">
                </div>
                <div>
                  <label for="ORG_EMAIL">Correo electrónico</label>
                  <input type="email" id="ORG_EMAIL" name="ORG_EMAIL" maxlength="100" placeholder="contacto@empresa.com">
                </div>
              </div>
              <div class="row">
                <label for="ORG_CONTACT">Persona de contacto <span class="note">(opcional)</span></label>
                <input type="text" id="ORG_CONTACT" name="ORG_CONTACT" maxlength="120" placeholder="Nombre completo">
              </div>
            </div>

            <!-- Dirección del pagador (aplica a persona u organización) -->
            <fieldset>
              <legend>Dirección del pagador</legend>
              <div class="row">
                <label for="PAYER_ADDR1">Dirección (línea 1)</label>
                <input type="text" id="PAYER_ADDR1" name="PAYER_ADDR1" maxlength="120" autocomplete="address-line1">
              </div>
              <div class="row">
                <label for="PAYER_ADDR2">Dirección (línea 2) <span class="note">(opcional)</span></label>
                <input type="text" id="PAYER_ADDR2" name="PAYER_ADDR2" maxlength="120" autocomplete="address-line2">
              </div>
              <div class="grid-2">
                <div>
                  <label for="PAYER_CITY">Ciudad</label>
                  <input type="text" id="PAYER_CITY" name="PAYER_CITY" maxlength="64" autocomplete="address-level2" placeholder="Ej. Monterrey">
                </div>
                <div>
                  <label for="PAYER_COUNTRY">País/Región</label>
                  <select id="PAYER_COUNTRY" name="PAYER_COUNTRY"></select>
                </div>
              </div>

              <!-- Variante EE. UU. -->
              <div id="payerUSBlock" class="grid-2" hidden>
                <div>
                  <label for="PAYER_US_STATE">Estado (EE. UU.)</label>
                  <select id="PAYER_US_STATE" name="PAYER_US_STATE"></select>
                </div>
                <div>
                  <label for="PAYER_US_ZIP">Código postal</label>
                  <input type="text" id="PAYER_US_ZIP" name="PAYER_US_ZIP" inputmode="numeric" maxlength="10" placeholder="##### o #####-####" autocomplete="postal-code">
                </div>
              </div>

              <!-- Variante fuera de EE. UU. -->
              <div id="payerNonUSBlock" class="grid-2" hidden>
                <div>
                  <label for="PAYER_PROVINCE">Estado/Provincia</label>
                  <input type="text" id="PAYER_PROVINCE" name="PAYER_PROVINCE" maxlength="64" placeholder="Ej. Jalisco">
                </div>
                <div>
                  <label for="PAYER_POSTAL">Código postal</label>
                  <input type="text" id="PAYER_POSTAL" name="PAYER_POSTAL" maxlength="16" placeholder="Ej. 44190">
                </div>
              </div>
            </fieldset>
          </div>
        </fieldset>

        <div class="actions">
          <button type="button" id="backBtn">Regresar</button>
          <button type="button" id="nextBtn" class="primary">Siguiente</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const NEXT_URL = new URL('personal4.html', window.location.href).href;
    const BACK_URL = new URL('personal2.html', window.location.href).href;

    const STORAGE_PREFIX = 'ds160:';
    const FORM_ID = 'ds160-travel';
    const PURPOSE_COUNT_KEY = STORAGE_PREFIX + FORM_ID + ':PURPOSE_COUNT';

    function storageKey(field) {
      const idOrName = field.type === 'radio' ? field.name : (field.id || field.name);
      return STORAGE_PREFIX + FORM_ID + ':' + idOrName;
    }
    function saveField(field) {
      try {
        if (field.type === 'radio') {
          if (field.checked) localStorage.setItem(storageKey(field), field.value);
        } else if (field.type === 'checkbox') {
          localStorage.setItem(storageKey(field), field.checked ? '1' : '0');
        } else {
          localStorage.setItem(storageKey(field), field.value);
        }
      } catch(e) {}
    }
    function restoreField(field) {
      try {
        const key = storageKey(field);
        const v = localStorage.getItem(key);
        if (v == null) return;
        if (field.type === 'radio') {
          field.checked = (field.value === v);
        } else if (field.type === 'checkbox') {
          field.checked = (v === '1');
        } else {
          field.value = v;
        }
      } catch(e) {}
    }
    function autosave(form) {
      form.addEventListener('input', (e) => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;
        if (t.matches('input,select,textarea')) saveField(t);
      }, true);
      form.addEventListener('change', (e) => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;
        if (t.matches('input,select,textarea')) saveField(t);
      }, true);
    }
    function restoreForm(form) {
      const fields = form.querySelectorAll('input,select,textarea');
      fields.forEach(f => restoreField(f));
    }

    const PURPOSE_OPTIONS = [
      {v:"", t:"— Seleccione una clase de visa —"},
      {v:"A", t:"FUNCIONARIO DE GOBIERNO EXTRANJERO (A)"},
      {v:"B", t:"VISITANTE TEMPORAL POR NEGOCIOS O TURISMO (B)"},
      {v:"C", t:"EXTRANJERO EN TRÁNSITO (C)"},
      {v:"CNMI", t:"TRABAJADOR/INVERSIONISTA EN CNMI (CW/E2C)"},
      {v:"D", t:"MIEMBRO DE TRIPULACIÓN (D)"},
      {v:"E", t:"COMERCIANTE/INVERSIONISTA POR TRATADO (E)"},
      {v:"F", t:"ESTUDIANTE ACADÉMICO O DE IDIOMA (F)"},
      {v:"G", t:"REPRESENTANTE/EMPLEADO DE ORGANIZACIÓN INTERNACIONAL (G)"},
      {v:"H", t:"TRABAJADOR TEMPORAL (H)"},
      {v:"I", t:"REPRESENTANTE DE MEDIOS EXTRANJEROS (I)"},
      {v:"J", t:"VISITANTE DE INTERCAMBIO (J)"},
      {v:"K", t:"PROMETIDO(A) O CÓNYUGE DE CIUDADANO(A) DE EE. UU. (K)"},
      {v:"L", t:"TRANSFERIDO INTRACOMPAÑÍA (L)"},
      {v:"M", t:"ESTUDIANTE VOCACIONAL/NO ACADÉMICO (M)"},
      {v:"N", t:"OTRO (N)"},
      {v:"NATO", t:"PERSONAL DE LA OTAN (NATO)"},
      {v:"O", t:"EXTRANJERO CON HABILIDAD EXTRAORDINARIA (O)"},
      {v:"P", t:"ARTISTA/DEPORTISTA RECONOCIDO INTERNACIONALMENTE (P)"},
      {v:"Q", t:"VISITANTE DE INTERCAMBIO CULTURAL (Q)"},
      {v:"R", t:"TRABAJADOR RELIGIOSO (R)"},
      {v:"S", t:"INFORMANTE O TESTIGO (S)"},
      {v:"T", t:"VÍCTIMA DE TRATA (T)"},
      {v:"TD/TN", t:"PROFESIONAL BAJO T-MEC (TD/TN)"},
      {v:"U", t:"VÍCTIMA DE ACTIVIDAD CRIMINAL (U)"},
      {v:"PAROLE-BEN", t:"BENEFICIARIO DE PERMISO (PARCIS)"}
    ];

    const US_STATES = [
      "", "AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC","PR","GU","VI"
    ];

    const COUNTRIES = [
      {c:"", n:"- Seleccione -"},
      {c:"US", n:"ESTADOS UNIDOS"},
      {c:"MX", n:"MÉXICO"},
      {c:"CA", n:"CANADÁ"},
      {c:"AR", n:"ARGENTINA"},
      {c:"BR", n:"BRASIL"},
      {c:"CL", n:"CHILE"},
      {c:"CO", n:"COLOMBIA"},
      {c:"CR", n:"COSTA RICA"},
      {c:"ES", n:"ESPAÑA"},
      {c:"FR", n:"FRANCIA"},
      {c:"GB", n:"REINO UNIDO"},
      {c:"DE", n:"ALEMANIA"},
      {c:"IT", n:"ITALIA"},
      {c:"JP", n:"JAPÓN"},
      {c:"CN", n:"CHINA"}
    ];

    function populatePurposeSelect(selectEl){
      selectEl.innerHTML = '';
      PURPOSE_OPTIONS.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt.v;
        o.textContent = opt.t;
        selectEl.appendChild(o);
      });
    }
    function populateStateSelect(selectEl){
      selectEl.innerHTML = '';
      US_STATES.forEach(code => {
        const o = document.createElement('option');
        o.value = code;
        o.textContent = code ? code : "- Seleccione -";
        selectEl.appendChild(o);
      });
    }
    function populateCountries(selectEl){
      selectEl.innerHTML = '';
      COUNTRIES.forEach(k => {
        const o = document.createElement('option');
        o.value = k.c;
        o.textContent = k.n;
        selectEl.appendChild(o);
      });
    }

    const form = document.getElementById(FORM_ID);
    const purposeList = document.getElementById('purposeList');
    const addPurposeBtn = document.getElementById('addPurposeBtn');

    function purposeCount(){
      const v = parseInt(localStorage.getItem(PURPOSE_COUNT_KEY) || '1', 10);
      return Number.isFinite(v) && v > 0 ? v : 1;
    }
    function setPurposeCount(n){
      localStorage.setItem(PURPOSE_COUNT_KEY, String(Math.max(1, n)));
    }

    function makePurposeItem(index){
      const wrap = document.createElement('div');
      wrap.className = 'purpose-item';

      const select = document.createElement('select');
      select.id = `PURPOSE_${index}`;
      select.name = `PURPOSE_${index}`;
      select.required = true;
      select.className = 'small';
      populatePurposeSelect(select);

      const remove = document.createElement('button');
      remove.type = 'button';
      remove.className = 'remove';
      remove.textContent = 'Eliminar';
      remove.addEventListener('click', () => {
        purposeList.removeChild(wrap);
        reindexPurposeItems();
        setPurposeCount(purposeList.children.length);
      });

      wrap.appendChild(select);
      wrap.appendChild(remove);
      return wrap;
    }

    function reindexPurposeItems(){
      [...purposeList.children].forEach((item, i) => {
        const sel = item.querySelector('select');
        sel.id = `PURPOSE_${i}`;
        sel.name = `PURPOSE_${i}`;
      });
      refreshPurposeRemoveButtons();
    }

    function refreshPurposeRemoveButtons(){
      const items = [...purposeList.children];
      items.forEach((item) => {
        const btn = item.querySelector('button.remove');
        btn.hidden = items.length <= 1;
      });
    }

    function addPurpose(){
      const idx = purposeList.children.length;
      const item = makePurposeItem(idx);
      purposeList.appendChild(item);
      setPurposeCount(purposeList.children.length);
    }
    addPurposeBtn.addEventListener('click', addPurpose);

    (function initPurposeFromStorage(){
      const count = purposeCount();
      for (let i=0; i<count; i++){
        const item = makePurposeItem(i);
        purposeList.appendChild(item);
      }
      [...purposeList.querySelectorAll('select')].forEach(sel => restoreField(sel));
      refreshPurposeRemoveButtons();
    })();

    const specificY = document.getElementById('SpecificTravelPlansY');
    const specificN = document.getElementById('SpecificTravelPlansN');
    const specificSection = document.getElementById('specificPlansSection');

    const ARRIVAL_DATE = document.getElementById('ARRIVAL_DATE');
    const DEPARTURE_DATE = document.getElementById('DEPARTURE_DATE');
    const ARRIVAL_CITY = document.getElementById('ARRIVAL_CITY');
    const ARRIVAL_STATE = document.getElementById('ARRIVAL_STATE');
    const DEPARTURE_CITY = document.getElementById('DEPARTURE_CITY');
    const DEPARTURE_STATE = document.getElementById('DEPARTURE_STATE');
    const STAY_ADDR1 = document.getElementById('STAY_ADDR1');
    const STAY_CITY = document.getElementById('STAY_CITY');
    const STAY_STATE = document.getElementById('STAY_STATE');
    const STAY_ZIP = document.getElementById('STAY_ZIP');

    [ARRIVAL_STATE, DEPARTURE_STATE, STAY_STATE].forEach(populateStateSelect);

    function setRequiredForSpecific(show){
      [ARRIVAL_DATE, DEPARTURE_DATE, ARRIVAL_CITY, ARRIVAL_STATE, STAY_ADDR1, STAY_CITY, STAY_STATE, STAY_ZIP]
        .forEach(el => el.required = show);
      [ARRIVAL_DATE, DEPARTURE_DATE, ARRIVAL_CITY, STAY_ADDR1, STAY_CITY, STAY_ZIP].forEach(el => el.setCustomValidity(''));
    }
    function updateSpecificSection(){
      const show = specificY.checked;
      specificSection.hidden = !show;
      setRequiredForSpecific(show);
    }
    [specificY, specificN].forEach(r => r.addEventListener('change', updateSpecificSection));

    const PAYER = document.getElementById('PAYER');
    const payerFields = document.getElementById('payerFields');
    const payerPersonFields = document.getElementById('payerPersonFields');
    const payerOrgFields = document.getElementById('payerOrgFields');

    const PAYER_SURNAME = document.getElementById('PAYER_SURNAME');
    const PAYER_GIVEN = document.getElementById('PAYER_GIVEN');
    const PAYER_REL = document.getElementById('PAYER_REL');
    const PAYER_PHONE = document.getElementById('PAYER_PHONE');
    const PAYER_EMAIL = document.getElementById('PAYER_EMAIL');

    const ORG_NAME = document.getElementById('ORG_NAME');
    const ORG_PHONE = document.getElementById('ORG_PHONE');
    const ORG_EMAIL = document.getElementById('ORG_EMAIL');
    const ORG_CONTACT = document.getElementById('ORG_CONTACT');

    const PAYER_ADDR1 = document.getElementById('PAYER_ADDR1');
    const PAYER_ADDR2 = document.getElementById('PAYER_ADDR2');
    const PAYER_CITY = document.getElementById('PAYER_CITY');
    const PAYER_COUNTRY = document.getElementById('PAYER_COUNTRY');
    const payerUSBlock = document.getElementById('payerUSBlock');
    const payerNonUSBlock = document.getElementById('payerNonUSBlock');
    const PAYER_US_STATE = document.getElementById('PAYER_US_STATE');
    const PAYER_US_ZIP = document.getElementById('PAYER_US_ZIP');
    const PAYER_PROVINCE = document.getElementById('PAYER_PROVINCE');
    const PAYER_POSTAL = document.getElementById('PAYER_POSTAL');

    populateCountries(PAYER_COUNTRY);
    populateStateSelect(PAYER_US_STATE);

    function isPersonType(code){ return code === 'H' || code === 'O'; }
    function isOrgType(code){ return code === 'P' || code === 'U' || code === 'C'; }

    function setRequiredForPayer(code){
      const isPerson = isPersonType(code);
      const isOrg = isOrgType(code);
      const show = !!code && code !== 'S';

      payerFields.hidden = !show;
      payerPersonFields.hidden = !isPerson;
      payerOrgFields.hidden = !isOrg;

      [PAYER_ADDR1, PAYER_CITY, PAYER_COUNTRY].forEach(el => el.required = show);

      updatePayerCountryBlock();

      [PAYER_SURNAME, PAYER_GIVEN, PAYER_PHONE, PAYER_EMAIL, PAYER_REL].forEach(el => el.required = isPerson);

      [ORG_NAME, ORG_PHONE, ORG_EMAIL].forEach(el => el.required = isOrg);
      ORG_CONTACT.required = false;
    }

    function updatePayerCountryBlock(){
      const c = PAYER_COUNTRY.value;
      const isUS = c === 'US';
      payerUSBlock.hidden = !isUS;
      payerNonUSBlock.hidden = isUS;

      const show = !payerFields.hidden;
      [PAYER_US_STATE, PAYER_US_ZIP].forEach(el => el.required = show && isUS);
      [PAYER_PROVINCE, PAYER_POSTAL].forEach(el => el.required = show && !isUS);
    }

    PAYER.addEventListener('change', () => {
      saveField(PAYER);
      setRequiredForPayer(PAYER.value);
    });
    PAYER_COUNTRY.addEventListener('change', () => {
      saveField(PAYER_COUNTRY);
      updatePayerCountryBlock();
    });

    restoreForm(form);

    updateSpecificSection();

    setRequiredForPayer(PAYER.value || '');
    updatePayerCountryBlock();

    autosave(form);

    function checkForm(){
      const selects = purposeList.querySelectorAll('select');
      for (const s of selects){
        if (!s.value){ s.setCustomValidity('Seleccione una clase de visa.'); }
        else { s.setCustomValidity(''); }
      }
      return form.checkValidity();
    }

    document.getElementById('backBtn').addEventListener('click', () => {
      form.querySelectorAll('input,select,textarea').forEach(saveField);
      window.location.assign(BACK_URL);
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      if (!checkForm()){
        form.reportValidity();
        const firstInvalid = form.querySelector(':invalid');
        if (firstInvalid) firstInvalid.scrollIntoView({behavior:'smooth', block:'center'});
        return;
      }
      form.querySelectorAll('input,select,textarea').forEach(saveField);
      window.location.assign(NEXT_URL);
    });

    (function initPurposeAfterRestore(){
      const PURPOSE_COUNT_KEY = STORAGE_PREFIX + FORM_ID + ':PURPOSE_COUNT';
      const count = parseInt(localStorage.getItem(PURPOSE_COUNT_KEY) || '1', 10);
      purposeList.innerHTML = "";
      for (let i=0; i<Math.max(1, count); i++){
        const item = makePurposeItem(i);
        purposeList.appendChild(item);
      }
      [...purposeList.querySelectorAll('select')].forEach(sel => restoreField(sel));
      refreshPurposeRemoveButtons();
    })();
  </script>
</body>
</html>
