<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nonimmigrant Visa - Travel Companions Information</title>
  <style>
    :root{
      color-scheme: light dark;
      --bg: #f6f7fb;
      --bg-grad: radial-gradient(1200px 600px at 10% -10%, #dfe7ff55, transparent 60%),
                 radial-gradient(800px 400px at 110% 10%, #ffe6d655, transparent 60%);
      --card: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --border: #e2e8f0;
      --accent: #2563eb;
      --accent-600: #1d4ed8;
      --accent-700: #1e40af;
      --ring: #93c5fd;
      --shadow: 0 10px 30px rgba(2, 8, 23, .08);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0b1220;
        --bg-grad: radial-gradient(1200px 600px at 10% -10%, #1d2a4e75, transparent 60%),
                   radial-gradient(800px 400px at 110% 10%, #4e2a1d75, transparent 60%);
        --card: #0f172a;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --border: #233044;
        --accent: #60a5fa;
        --accent-600: #3b82f6;
        --accent-700: #2563eb;
        --ring: #60a5fa;
        --shadow: 0 12px 36px rgba(0,0,0,.35);
      }
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      line-height: 1.45;
      color: var(--text);
      background: var(--bg);
      background-image: var(--bg-grad);
      overflow-x: hidden;
    }

    .wrap { max-width: 960px; margin: 32px auto; padding: 0 16px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 24px;
      box-shadow: var(--shadow);
      backdrop-filter: saturate(120%) blur(4px);
    }

    fieldset {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      margin: 16px 0;
      background: linear-gradient(180deg, rgba(148,163,184,.06), transparent 60%);
    }
    legend { font-weight: 700; padding: 0 10px; font-size: .98rem; }
    legend::after{
      content: ""; display: inline-block; width: 8px; height: 8px; margin-left: 8px; border-radius: 999px;
      background: var(--accent); box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 20%, transparent);
    }

    label { display: inline-block; margin: 8px 0 6px; font-weight: 600; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .inline { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

    input[type="text"], select {
      width: 100%;
      max-width: 560px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      color: var(--text);
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease, transform .06s ease;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
      /* Visual: mostrar en mayúsculas */
      text-transform: uppercase;
    }
    input[type="text"]:focus, select:focus {
      border-color: var(--accent); box-shadow: 0 0 0 3px color-mix(in oklab, var(--ring) 45%, transparent);
    }

    .help { font-size: .9rem; color: var(--muted); margin-top: 2px; }
    .actions { margin-top: 18px; display: flex; gap: 12px; align-items: center; border-top: 1px dashed var(--border); padding-top: 16px; }
    button {
      padding: 10px 16px; border-radius: 12px; border: 1px solid var(--border); background: var(--card);
      cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 600;
      transition: transform .06s ease, box-shadow .15s ease, background .2s ease, border-color .15s ease;
    }
    button.primary { background: linear-gradient(180deg, var(--accent), var(--accent-600)); color: white; border-color: transparent; box-shadow: 0 6px 16px rgba(37,99,235,.35); }
    button.primary:hover { background: linear-gradient(180deg, var(--accent-600), var(--accent-700)); transform: translateY(-0.5px); }

    .hide { display:none !important; }

    /* ----- Un campo por línea en cada acompañante ----- */
    .companion-item{
      display: grid;
      grid-template-columns: 1fr;   /* SIEMPRE una sola columna */
      gap: 10px;
    }
    .companion-item button.remove{ border-color:#ef4444; color:#ef4444; width: fit-content; }
    .companion-item button.remove:hover{ background:#ef44441a; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <form id="ds160-travelcompanions" action="#" method="post" novalidate>
        <fieldset>
          <legend>Información de acompañantes de viaje</legend>

          <!-- ¿Hay otras personas viajando con usted? -->
          <div class="row">
            <label>¿Hay otras personas viajando con usted?</label>
            <div class="inline" role="radiogroup" aria-label="Otras personas viajando con usted">
              <label style="font-weight:400;">
                <input type="radio" name="OtherPersonsTravelingWithYou" value="Y" id="OtherY" required> Sí
              </label>
              <label style="font-weight:400;">
                <input type="radio" name="OtherPersonsTravelingWithYou" value="N" id="OtherN"> No
              </label>
            </div>
            <p class="help">
              Responda “Sí” si viaja con familia o acompañante
            </p>
          </div>

          <!-- Solo visible si la respuesta es Sí -->
          <div id="withCompanionsSection" class="row hide">
            <!-- *** SE ELIMINÓ / OCULTÓ COMPLETAMENTE "Tipo de acompañamiento" (grupo u organización) *** -->

            <fieldset id="companionsListBlock">
              <legend>Personas que viajan con usted</legend>
              <div id="companionsList" class="row"></div>
              <div class="inline" style="margin-top:8px;">
                <button type="button" id="addCompanionBtn">Agregar acompañante</button>
              </div>
              <p class="help">Agregue cada acompañante con su relación.</p>
            </fieldset>
          </div>
        </fieldset>

        <div class="actions">
          <button type="button" id="backBtn">Regresar</button>
          <button type="button" id="nextBtn" class="primary">Siguiente</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Navegación
    const BACK_URL = new URL('Travel.html', window.location.href).href;
    const NEXT_URL = new URL('PreviousUSTravel.html', window.location.href).href;

    // Persistencia local
    const STORAGE_PREFIX = 'ds160:';
    const FORM_ID = 'ds160-travelcompanions';
    const COMP_COUNT_KEY = STORAGE_PREFIX + FORM_ID + ':COMP_COUNT';

    // Regla: SOLO MAYÚSCULAS (letras españolas) y ESPACIOS
    const UPPER_ALLOWED_RE = /[^A-ZÁÉÍÓÚÜÑ\s]/g; // lo que NO está permitido
    const UPPER_PATTERN = "[A-ZÁÉÍÓÚÜÑ ]+";
    const UPPER_TITLE = "Solo letras mayúsculas (A–Z, Á, É, Í, Ó, Ú, Ü, Ñ) y espacios";

    function toUpperSanitized(v){
      // Normaliza a mayúsculas y elimina caracteres no permitidos
      return v.toLocaleUpperCase('es-MX').replace(UPPER_ALLOWED_RE, '');
    }

    function attachUpperBehavior(el){
      try{
        // Visual
        el.style.textTransform = 'uppercase';
        // Validación nativa
        el.setAttribute('pattern', UPPER_PATTERN);
        el.setAttribute('title', UPPER_TITLE);
        // En tiempo real
        el.addEventListener('input', () => {
          const before = el.value;
          const after = toUpperSanitized(before);
          if (before !== after) {
            const start = el.selectionStart, end = el.selectionEnd;
            el.value = after;
            // intenta conservar la posición del cursor
            const diff = before.length - after.length;
            const ns = Math.max(0, (start ?? after.length) - diff);
            const ne = Math.max(0, (end ?? after.length) - diff);
            try { el.setSelectionRange(ns, ne); } catch(_) {}
          }
        }, { passive: true });
        // Fuerza conversión inicial si trae datos del storage / autocompletado
        el.value = toUpperSanitized(el.value || "");
      }catch(_){}
    }

    function storageKey(field) {
      const idOrName = field.type === 'radio' ? field.name : (field.id || field.name);
      return STORAGE_PREFIX + FORM_ID + ':' + idOrName;
    }
    function saveField(field) {
      try {
        if (field.type === 'radio') {
          if (field.checked) localStorage.setItem(storageKey(field), field.value);
        } else {
          // Guardar ya normalizado si es texto
          const val = field.type === 'text' ? toUpperSanitized(field.value) : field.value;
          localStorage.setItem(storageKey(field), val);
        }
      } catch(e) {}
    }
    function restoreField(field) {
      try {
        const key = storageKey(field);
        const v = localStorage.getItem(key);
        if (v == null) return;
        if (field.type === 'radio') {
          field.checked = (field.value === v);
        } else {
          // Restaurar y sanear si es texto
          field.value = field.type === 'text' ? toUpperSanitized(v) : v;
        }
      } catch(e) {}
    }
    function autosave(form) {
      form.addEventListener('input', (e) => {
        const t = e.target;
        if (t && t.matches('input,select,textarea')) saveField(t);
      }, true);
      form.addEventListener('change', (e) => {
        const t = e.target;
        if (t && t.matches('input,select,textarea')) saveField(t);
      }, true);
    }

    // Relación opciones
    const REL_OPTS = [
      {v:"", t:"- Relación -"},
      {v:"SPOUSE", t:"Esposo/a"},
      {v:"PARENT", t:"Padre/Madre"},
      {v:"CHILD", t:"Hijo/a"},
      {v:"SIBLING", t:"Hermano/a"},
      {v:"OTHERREL", t:"Otro familiar"},
      {v:"FRIEND", t:"Amigo/a"},
      {v:"COWORKER", t:"Colega"},
      {v:"OTHER", t:"Otro"}
    ];

    // DOM refs
    const form = document.getElementById(FORM_ID);
    const otherY = document.getElementById('OtherY');
    const otherN = document.getElementById('OtherN');
    const withCompanionsSection = document.getElementById('withCompanionsSection');
    const companionsListBlock = document.getElementById('companionsListBlock');
    const companionsList = document.getElementById('companionsList');
    const addCompanionBtn = document.getElementById('addCompanionBtn');

    // Helpers
    function saveCompanionCount(){
      localStorage.setItem(COMP_COUNT_KEY, String(companionsList.children.length));
    }
    function refreshRemoveButtons(){
      const items = [...companionsList.children];
      const hideRemove = items.length <= 1;
      items.forEach(i => {
        const b = i.querySelector('button.remove');
        if (b) b.style.visibility = hideRemove ? 'hidden' : 'visible';
      });
    }
    function relSelect(){
      const s = document.createElement('select');
      s.name = 'COMPANION_REL';
      s.required = true;
      REL_OPTS.forEach(o=>{
        const opt = document.createElement('option');
        opt.value = o.v; opt.textContent = o.t;
        s.appendChild(opt);
      });
      return s;
    }
    function makeCompanionItem(){
      const wrap = document.createElement('div');
      wrap.className = 'companion-item';

      // Apellido(s)
      const l1 = document.createElement('div');
      const lab1 = document.createElement('label'); lab1.textContent = 'Apellido(s)';
      const in1 = document.createElement('input');
      in1.type='text'; in1.name='COMPANION_SURNAME'; in1.maxLength=60; in1.required = true;
      in1.setAttribute('pattern', UPPER_PATTERN);
      in1.setAttribute('title', UPPER_TITLE);
      attachUpperBehavior(in1);
      l1.appendChild(lab1); l1.appendChild(in1);

      // Nombre(s)
      const l2 = document.createElement('div');
      const lab2 = document.createElement('label'); lab2.textContent = 'Nombre(s)';
      const in2 = document.createElement('input');
      in2.type='text'; in2.name='COMPANION_GIVEN'; in2.maxLength=60; in2.required = true;
      in2.setAttribute('pattern', UPPER_PATTERN);
      in2.setAttribute('title', UPPER_TITLE);
      attachUpperBehavior(in2);
      l2.appendChild(lab2); l2.appendChild(in2);

      // Relación
      const l3 = document.createElement('div');
      const lab3 = document.createElement('label'); lab3.textContent = 'Relación';
      const sel = relSelect();
      l3.appendChild(lab3); l3.appendChild(sel);

      // Eliminar
      const l4 = document.createElement('div');
      const btn = document.createElement('button');
      btn.type='button'; btn.className='remove'; btn.textContent='Eliminar';
      btn.addEventListener('click', () => {
        companionsList.removeChild(wrap);
        saveCompanionCount();
        refreshRemoveButtons();
      });
      l4.appendChild(btn);

      wrap.appendChild(l1); wrap.appendChild(l2); wrap.appendChild(l3); wrap.appendChild(l4);
      return wrap;
    }
    function addCompanion(){
      const item = makeCompanionItem();
      companionsList.appendChild(item);
      saveCompanionCount();
      refreshRemoveButtons();
    }

    function updateMainVisibility(){
      const show = otherY.checked;
      withCompanionsSection.classList.toggle('hide', !show);
      if (!show){
        companionsList.innerHTML = "";
        saveCompanionCount();
      } else {
        if (companionsList.children.length === 0) addCompanion();
      }
    }

    // Autosave + restauración
    autosave(form);
    form.querySelectorAll('input[type="radio"]').forEach(restoreField);

    // Aplicar restricción de MAYÚSCULAS a todos los inputs de texto existentes
    document.querySelectorAll('input[type="text"]').forEach(attachUpperBehavior);

    // Restaurar valores (y normalizar si vienen del storage)
    form.querySelectorAll('input[type="text"], select, textarea').forEach(restoreField);

    updateMainVisibility();
    const count = parseInt(localStorage.getItem(COMP_COUNT_KEY) || '0', 10);
    if (otherY.checked){
      const n = Math.max(1, isFinite(count) ? count : 1);
      for (let i=companionsList.children.length; i<n; i++) addCompanion();
    }

    addCompanionBtn.addEventListener('click', addCompanion);
    [otherY, otherN].forEach(r => r.addEventListener('change', () => { saveField(r); updateMainVisibility(); }));

    function checkForm(){
      if (!otherY.checked) return form.checkValidity();
      const items = [...companionsList.children];
      if (items.length === 0){
        alert('Agregue al menos un acompañante.');
        return false;
      }
      for (const item of items){
        const sname = item.querySelector('input[name="COMPANION_SURNAME"]');
        const gname = item.querySelector('input[name="COMPANION_GIVEN"]');
        const rel = item.querySelector('select[name="COMPANION_REL"]');
        if (!sname.value.trim()) { sname.reportValidity(); sname.focus(); return false; }
        if (!gname.value.trim()) { gname.reportValidity(); gname.focus(); return false; }
        if (!rel.value)          { rel.reportValidity();  rel.focus();  return false; }
      }
      return form.checkValidity();
    }

    document.getElementById('backBtn').addEventListener('click', () => {
      form.querySelectorAll('input,select,textarea').forEach(saveField);
      window.location.assign(BACK_URL);
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      if (!checkForm()){
        form.reportValidity();
        const firstInvalid = form.querySelector(':invalid');
        if (firstInvalid) firstInvalid.scrollIntoView({behavior:'smooth', block:'center'});
        return;
      }
      form.querySelectorAll('input,select,textarea').forEach(saveField);
      window.location.assign(NEXT_URL);
    });
  </script>
</body>
</html>
