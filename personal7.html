<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personal 7</title>
  <style>
    :root{
      color-scheme: light dark;
      --bg: #f6f7fb;
      --bg-grad: radial-gradient(1200px 600px at 10% -10%, #dfe7ff55, transparent 60%),
                 radial-gradient(800px 400px at 110% 10%, #ffe6d655, transparent 60%);
      --card: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --border: #e2e8f0;
      --accent: #2563eb;
      --accent-600: #1d4ed8;
      --accent-700: #1e40af;
      --ring: #93c5fd;
      --shadow: 0 10px 30px rgba(2, 8, 23, .08);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0b1220;
        --bg-grad: radial-gradient(1200px 600px at 10% -10%, #1d2a4e75, transparent 60%),
                   radial-gradient(800px 400px at 110% 10%, #4e2a1d75, transparent 60%);
        --card: #0f172a;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --border: #233044;
        --accent: #60a5fa;
        --accent-600: #3b82f6;
        --accent-700: #2563eb;
        --ring: #60a5fa;
        --shadow: 0 12px 36px rgba(0,0,0,.35);
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:16px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:var(--bg);
      background-image: var(--bg-grad);
    }

    .wrap{max-width:960px;margin:32px auto;padding:0 16px}

    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:24px}
    .brand{display:flex;align-items:center;gap:14px}
    /* .logo eliminado */

    h1{margin:0;font-size:1.35rem;letter-spacing:-.01em}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card header{padding:18px 20px;border-bottom:1px solid var(--border);background:linear-gradient(180deg, rgba(148,163,184,.06), transparent 70%)}
    .card header h2{margin:0;font-size:1.05rem}

    form{padding:10px 20px 0}

    fieldset{
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px;
      margin:16px 0;
      background:linear-gradient(180deg, rgba(148,163,184,.06), transparent 60%);
    }
    legend{padding:0 8px;color:var(--text);font-weight:700;font-size:.98rem}
    legend::after{
      content:""; display:inline-block; width:8px; height:8px; margin-left:8px; border-radius:999px;
      background: var(--accent); box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 20%, transparent);
    }

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    @media (max-width:800px){.col-6{grid-column:span 12}}

    label{display:inline-block;margin:3px 0 6px;color:var(--text);font-weight:600}
    .req::after{
      content:"";
      display:inline-block;
      width:8px;
      height:8px;
      margin-left:8px;
      border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 20%, transparent);
      vertical-align: middle;
    }

    input[type="text"], input:not([type]), textarea, input[type="date"], select{
      width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--border);
      background:var(--card);color:var(--text);outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,.05);
      transition:border-color .15s ease, box-shadow .15s ease, transform .06s ease;
    }
    input[type="text"], input:not([type]), textarea{ text-transform:uppercase; }
    input[type="text"]::placeholder, input:not([type])::placeholder, textarea::placeholder{color:#6b7280;text-transform:none}
    input[type="date"]:focus, select:focus, textarea:focus, input[type="text"]:focus, input:not([type]):focus{
      border-color:var(--accent);
      box-shadow:0 0 0 3px color-mix(in oklab, var(--ring) 45%, transparent);
    }

    input[disabled]{opacity:.6}
    .help,.hint{font-size:.9rem;color:var(--muted)}
    .hstack{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .radio-group{display:flex;gap:18px}

    .actions{
      margin-top:18px; display:flex; gap:12px; align-items:center;
      border-top:1px dashed var(--border); padding:16px 20px; background:transparent;
      border-bottom-left-radius:18px; border-bottom-right-radius:18px;
    }
    button{
      appearance:none;border:1px solid var(--border);border-radius:12px;padding:10px 16px;
      background:var(--card);color:var(--text);font-weight:600;cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
      transition:transform .06s ease, box-shadow .15s ease, background .2s ease, border-color .15s ease;
    }
    button:hover{ transform:translateY(-0.5px); background: color-mix(in oklab, var(--card) 92%, var(--accent) 8%); }
    button.primary{
      background:linear-gradient(180deg, var(--accent), var(--accent-600)); border-color:transparent; color:white;
      box-shadow:0 6px 16px rgba(37,99,235,.35)
    }
    button.primary:hover{ background:linear-gradient(180deg, var(--accent-600), var(--accent-700)) }

    .errors{
      background: color-mix(in oklab, #ef4444 12%, transparent);
      border:1px solid color-mix(in oklab, #ef4444 45%, transparent);
      color:#7f1d1d; padding:12px 14px; border-radius:12px; margin:8px 0; display:none
    }
    .success{
      background: color-mix(in oklab, #22c55e 12%, transparent);
      border:1px solid color-mix(in oklab, #22c55e 45%, transparent);
      color:#14532d; padding:12px 14px; border-radius:12px; margin:8px 0; display:none
    }

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    #lostDetails{display:none}
    #lostDetails.show{display:grid}

    /* helper para ocultar bloques (amarillos) */
    .hide{display:none !important;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <!-- logo eliminado -->
        <div></div>
      </div>
    </header>

    <div class="card" role="region" aria-labelledby="t-passport">
      <header>
        <h2 id="t-passport">Información del pasaporte</h2>
      </header>

      <form id="formDS160" novalidate>
        <div id="errorBox" class="errors" role="alert"></div>
        <div id="okBox" class="success" role="status"></div>

        <fieldset>
          <legend>Documento</legend>
          <div class="grid">
            <!-- OCULTO (marco amarillo 1): tipo de pasaporte + ayuda -->
            <div class="col-6 hide" id="block_passport_type">
              <label for="passport_type" class="req">Tipo de pasaporte / documento</label>
              <select id="passport_type" name="passport_type" required>
                <option value="" selected>— Selecciona —</option>
                <option value="REGULAR">REGULAR</option>
                <option value="OFFICIAL">OFFICIAL</option>
                <option value="DIPLOMATIC">DIPLOMATIC</option>
                <option value="LAISSEZ-PASSER">LAISSEZ-PASSER</option>
                <option value="OTHER">OTHER</option>
              </select>
              <div class="help">Si tu libreta es ordinaria, elige <b>REGULAR</b>.</div>
            </div>

            <div class="col-6">
              <label for="passport_number" class="req">Número de pasaporte</label>
              <input id="passport_number" name="passport_number" type="text" maxlength="20" inputmode="text" pattern="^[A-Z0-9]{1,20}$" placeholder="Ej.: G12345678" />
            </div>

            <!-- OCULTO (marco amarillo 2): Passport Book Number + No aplica -->
            <div class="col-6 hide" id="block_passport_book">
              <label for="passport_book_number">Passport Book Number</label>
              <input id="passport_book_number" name="passport_book_number" type="text" maxlength="20" placeholder="Si no aplica, marca la casilla" />
              <div class="hstack">
                <input id="book_na" type="checkbox" />
                <label for="book_na">No aplica</label>
              </div>
            </div>

            <div class="col-6">
              <label for="issuing_country" class="req">País/Autoridad que emitió</label>
              <select id="issuing_country" name="issuing_country" required>
                <option value="" selected>— Selecciona —</option>
                <option value="MEXICO">MEXICO</option>
                <option value="UNITED STATES OF AMERICA">UNITED STATES OF AMERICA</option>
                <option value="CANADA">CANADA</option>
                <option value="SPAIN">SPAIN</option>
                <option value="ARGENTINA">ARGENTINA</option>
                <option value="COLOMBIA">COLOMBIA</option>
                <option value="PERU">PERU</option>
                <option value="CHILE">CHILE</option>
                <option value="BRAZIL">BRAZIL</option>
                <option value="UNITED KINGDOM">UNITED KINGDOM</option>
                <option value="GERMANY">GERMANY</option>
                <option value="FRANCE">FRANCE</option>
                <option value="ITALY">ITALY</option>
                <option value="JAPAN">JAPAN</option>
                <option value="CHINA">CHINA</option>
                <option value="INDIA">INDIA</option>
              </select>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Lugar de expedición</legend>
          <div class="grid">
            <div class="col-6">
              <label for="issued_city" class="req">Ciudad</label>
              <input id="issued_city" name="issued_city" type="text" maxlength="25" />
            </div>
            <div class="col-6">
              <label for="issued_state">Estado<span class="hint"> </span></label>
              <input id="issued_state" name="issued_state" type="text" maxlength="25" />
            </div>
            <div class="col-12">
              <label for="issued_country_region" class="req">País</label>
              <select id="issued_country_region" name="issued_country_region" required>
                <option value="" selected>— Selecciona —</option>
                <option value="MEXICO">MEXICO</option>
                <option value="UNITED STATES OF AMERICA">UNITED STATES OF AMERICA</option>
                <option value="CANADA">CANADA</option>
                <option value="SPAIN">SPAIN</option>
                <option value="ARGENTINA">ARGENTINA</option>
                <option value="COLOMBIA">COLOMBIA</option>
                <option value="PERU">PERU</option>
                <option value="CHILE">CHILE</option>
                <option value="BRAZIL">BRAZIL</option>
                <option value="UNITED KINGDOM">UNITED KINGDOM</option>
                <option value="GERMANY">GERMANY</option>
                <option value="FRANCE">FRANCE</option>
                <option value="ITALY">ITALY</option>
                <option value="JAPAN">JAPAN</option>
                <option value="CHINA">CHINA</option>
                <option value="INDIA">INDIA</option>
              </select>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Fechas</legend>
          <div class="grid">
            <div class="col-6">
              <label for="issuance_date" class="req">Fecha de expedición</label>
              <div class="date-wrap">
                <input id="issuance_date" name="issuance_date" type="date" required />
                <button type="button" id="issuance_btn" class="date-btn" aria-label="Abrir calendario" title="Abrir calendario">
                  <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <rect x="3" y="4" width="18" height="17" rx="3" stroke="currentColor" stroke-width="1.6"/>
                    <path d="M8 2v4M16 2v4M3 9h18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
              <div class="hint">Formato: DD/MM/AAAA.</div>
            </div>
            <div class="col-6">
              <label for="expiration_date" class="req">Fecha de vencimiento</label>
              <input id="expiration_date" name="expiration_date" type="date" required />
              <div class="hstack" style="margin-top:8px">
                <input id="no_exp" type="checkbox" />
                <label for="no_exp">No expira</label>
              </div>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Historial</legend>
          <div class="grid">
            <div class="col-12">
              <span class="req">¿Alguna vez ha perdido un pasaporte o le han robado uno?</span>
              <div class="radio-group" role="radiogroup" aria-label="Pérdida o robo de pasaporte">
                <label class="hstack"><input type="radio" name="lost_or_stolen" value="Y" required /> Sí</label>
                <label class="hstack"><input type="radio" name="lost_or_stolen" value="N" required /> No</label>
              </div>
              <div class="help">Si respondes «Sí», la versión oficial te pedirá detalles del documento.</div>
            </div>

            <div id="lostDetails" class="col-12 grid" style="grid-template-columns:repeat(12,1fr);gap:16px;margin-top:8px">
              <div class="col-6">
                <label for="lost_number">Número del pasaporte perdido/robado <span class="hint">(si lo recuerdas)</span></label>
                <input id="lost_number" name="lost_number" type="text" maxlength="20" />
              </div>
              <div class="col-6">
                <label for="lost_when">Fecha aproximada</label>
                <input id="lost_when" name="lost_when" type="date" />
              </div>
              <div class="col-12">
                <label for="lost_explain" class="req">Descripción breve</label>
                <textarea id="lost_explain" name="lost_explain" rows="3" maxlength="500" placeholder="EJ.: EXTRAVIADO EN 2019, EMITIDO POR MEXICO, REPORTE REALIZADO..."></textarea>
                <div class="help">Requerido si marcaste «Sí».</div>
              </div>
            </div>
          </div>
        </fieldset>

        <div class="actions">
          <button type="button" id="backBtn">Regresar</button>
          <button type="button" id="nextBtn" class="primary">Siguiente</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    const form = $('#formDS160');
    const errorBox = $('#errorBox');
    const okBox = $('#okBox');

    const bookNA = $('#book_na');
    const bookInput = $('#passport_book_number');
    const noExp = $('#no_exp');
    const expInput = $('#expiration_date');
    const lostDetails = $('#lostDetails');
    const issuanceInput = $('#issuance_date');
    const issuanceBtn = $('#issuance_btn');

    const STORAGE_KEY = 'ds160:passport:data';
    const BACK_URL = new URL('personal6.html', window.location.href).href;
    const NEXT_URL = new URL('personal8.html', window.location.href).href;

    const isHidden = el => {
      if (!el) return false;
      const st = getComputedStyle(el);
      return st.display === 'none' || st.visibility === 'hidden';
    };

    // Forzar MAYÚSCULAS (valor real)
    function attachUppercaseHandlers() {
      const inputs = $$('input[type="text"], input:not([type]), textarea', form);
      inputs.forEach(inp => {
        inp.setAttribute('autocapitalize','characters');
        inp.setAttribute('spellcheck','false');
        inp.setAttribute('autocomplete','off');
        const toUp = () => {
          const s = inp.selectionStart, e = inp.selectionEnd;
          const up = inp.value.toUpperCase();
          if (inp.value !== up) {
            inp.value = up;
            if (document.activeElement === inp && s !== null && e !== null) inp.setSelectionRange(s, e);
          }
        };
        inp.addEventListener('input', toUp);
        inp.addEventListener('change', toUp);
        if (inp.value) toUp();
      });
    }

    // Mostrar/ocultar detalles de pérdida/robo
    function toggleLostDetails() {
      const val = ($$('input[name="lost_or_stolen"]:checked')[0]?.value)||'';
      if (val === 'Y') lostDetails.classList.add('show');
      else lostDetails.classList.remove('show');
    }
    $$('input[name="lost_or_stolen"]').forEach(r => r.addEventListener('change', () => { toggleLostDetails(); save(); }));

    // Botón del calendario (Fecha de expedición)
    issuanceBtn.addEventListener('click', () => {
      if (issuanceInput?.showPicker) issuanceInput.showPicker();
      else issuanceInput?.focus();
    });

    // Toggle "Does Not Apply"
    bookNA?.addEventListener('change', () => {
      if (bookNA.checked) {
        bookInput.value = '';
        bookInput.disabled = true;
        bookInput.placeholder = 'No aplica';
      } else {
        bookInput.disabled = false;
        bookInput.placeholder = 'Si no aplica, marca la casilla';
      }
      save();
    });

    // Toggle "No Expiration"
    noExp?.addEventListener('change', () => {
      if (noExp.checked) { expInput.value = ''; expInput.disabled = true; }
      else { expInput.disabled = false; }
      save();
    });

    // ========= Persistencia =========
    function snapshotRaw(){
      return {
        passport_type: $('#passport_type').value||'',
        passport_number: ($('#passport_number').value||'').toUpperCase(),
        passport_book_number: $('#passport_book_number').disabled ? '' : ($('#passport_book_number').value||'').toUpperCase(),
        book_na: !!$('#book_na')?.checked,
        issuing_country: $('#issuing_country').value||'',
        issued_city: ($('#issued_city').value||'').toUpperCase(),
        issued_state: ($('#issued_state').value||'').toUpperCase(),
        issued_country_region: $('#issued_country_region').value||'',
        issuance_date: $('#issuance_date').value||'',
        no_expiration: !!$('#no_exp')?.checked,
        expiration_date: $('#expiration_date').value||'',
        lost_or_stolen: ($$('input[name="lost_or_stolen"]:checked')[0]?.value)||'',
        lost_number: ($('#lost_number').value||'').toUpperCase(),
        lost_when: $('#lost_when').value||'',
        lost_explain: ($('#lost_explain').value||'').toUpperCase()
      };
    }
    function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(snapshotRaw())); }catch(e){} }

    function restore(){
      try{
        const raw = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
        if (!raw || Object.keys(raw).length===0) {
          attachUppercaseHandlers();
          toggleLostDetails();
          return;
        }
        $('#passport_type').value = raw.passport_type||'';
        $('#passport_number').value = raw.passport_number||'';
        $('#passport_book_number').value = raw.passport_book_number||'';
        if (raw.book_na){ bookNA.checked = true; bookInput.disabled = true; bookInput.placeholder = 'No aplica'; }

        $('#issuing_country').value = raw.issuing_country||'';
        $('#issued_city').value = raw.issued_city||'';
        $('#issued_state').value = raw.issued_state||'';
        $('#issued_country_region').value = raw.issued_country_region||'';
        $('#issuance_date').value = raw.issuance_date||'';
        if (raw.no_expiration){ noExp.checked = true; expInput.disabled = true; }
        $('#expiration_date').value = raw.no_expiration ? '' : (raw.expiration_date||'');

        if (raw.lost_or_stolen){
          const r = $$('input[name="lost_or_stolen"]').find(x=>x.value===raw.lost_or_stolen);
          if (r) r.checked = true;
        }
        $('#lost_number').value = raw.lost_number||'';
        $('#lost_when').value = raw.lost_when||'';
        $('#lost_explain').value = raw.lost_explain||'';

        attachUppercaseHandlers();
        toggleLostDetails();
      }catch(e){
        attachUppercaseHandlers();
        toggleLostDetails();
      }
    }
    // ========= /Persistencia =========

    // Validación (omite campos ocultos)
    const validate = () => {
      const errors = [];
      if (!isHidden($('#block_passport_type')) && !$('#passport_type').value)
        errors.push('Selecciona el tipo de pasaporte.');
      const pn = ($('#passport_number').value||'').trim();
      if (!pn) errors.push('Ingresa el número de pasaporte.');
      else if (!/^[A-Z0-9]{1,20}$/.test(pn)) errors.push('El número de pasaporte debe tener solo letras/números (máx. 20).');
      if (!$('#issuing_country').value) errors.push('Selecciona el país/autoridad que emitió el pasaporte.');
      if (!($('#issued_city').value||'').trim()) errors.push('Indica la ciudad de expedición.');
      if (!$('#issued_country_region').value) errors.push('Selecciona el país/región de expedición.');
      if (!$('#issuance_date').value) errors.push('Indica la fecha de expedición.');
      if (!noExp.checked && !$('#expiration_date').value) errors.push('Indica la fecha de vencimiento o marca «No expira».');

      const lost = $$('input[name="lost_or_stolen"]:checked')[0];
      if (!lost) errors.push('Responde si perdiste o te robaron un pasaporte.');
      if (lost && lost.value==='Y' && !($('#lost_explain').value||'').trim()){
        errors.push('Describe brevemente el pasaporte perdido/robado.');
      }
      return errors;
    };

    const showErrors = (list) => {
      if (!list.length) { errorBox.style.display='none'; return; }
      errorBox.innerHTML = '<strong>Revisa lo siguiente:</strong><ul style="margin:6px 0 0 18px">' + list.map(e=>`<li>${e}</li>`).join('') + '</ul>';
      errorBox.style.display='block';
      okBox.style.display='none';
    };

    // Guardado automático
    form.addEventListener('input', save);
    form.addEventListener('change', save);

    document.getElementById('backBtn').addEventListener('click', () => {
      save();
      window.location.assign(BACK_URL);
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      const errs = validate();
      showErrors(errs);
      if (errs.length){
        form.reportValidity?.();
        const firstInvalid = form.querySelector(':invalid') || form.querySelector('#errorBox');
        if (firstInvalid) firstInvalid.scrollIntoView({behavior:'smooth', block:'center'});
        return;
      }
      save();
      window.location.assign(NEXT_URL);
    });

    // Init
    restore();
  </script>
</body>
</html>
