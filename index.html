<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sotelo Tramites Visa</title>
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --ink:#e8eefc; --muted:#9fb0d1; --accent:#6ba7ff; --ok:#35d07f; --err:#ff6b6b;}
    *{box-sizing:border-box}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(120deg,#0a1130,#091124 40%,#0b0f1a);
      color:var(--ink); margin:0;
    }
    header{position:sticky; top:0; background:rgba(10,16,30,.9); backdrop-filter: blur(8px);
      padding:16px 20px; border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; gap:12px; align-items:center; justify-content:space-between}
    header h1{font-size:18px; margin:0; font-weight:600}
    .wrap{max-width:560px; margin:24px auto 64px; padding:0 16px}
    .card{background:var(--card); border:1px solid rgba(255,255,255,.06);
      border-radius:20px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .grid{display:grid; gap:14px}
    .grid.cols-2,.grid.cols-3{grid-template-columns:1fr}
    label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px}
    input[type="text"], select, textarea{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12); background:#0e1627; color:var(--ink)
    }
    textarea{min-height:72px; resize:vertical}
    /* MAYÚSCULAS EN TIEMPO REAL (excepto nombre completo) */
    input[type="text"].upcase{ text-transform: uppercase; }

    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .muted{color:var(--muted)}
    .btn{cursor:pointer; padding:12px 16px; border-radius:14px; border:0; font-weight:700; width:100%}
    .btn.primary{background:var(--accent); color:#081225}
    .btn.ghost{background:transparent; border:1px solid rgba(255,255,255,.18); color:var(--ink)}
    .footer{display:flex; flex-direction:column; gap:12px; margin-top:18px}
    .hint{font-size:12px; color:var(--muted)}
    .hidden{display:none !important}
    @media (max-width:420px){header{flex-direction:column; align-items:flex-start; gap:8px}}

    /* Progreso de subida */
    .up-list{display:flex; flex-direction:column; gap:10px; margin-top:8px}
    .up-item{display:flex; flex-direction:column; gap:6px; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px}
    .up-head{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .up-name{font-size:12px; color:var(--ink); opacity:.9; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .up-pct{font-size:12px; color:var(--muted)}
    .up-bar{position:relative; height:8px; background:rgba(255,255,255,.12); border-radius:999px; overflow:hidden}
    .up-fill{position:absolute; inset:0 auto 0 0; width:0%; background:var(--accent); transition:width .2s ease}
    .up-item.ok .up-fill{background:var(--ok)}
    .up-item.err .up-fill{background:var(--err)}

    .radio-group{display:flex; gap:14px; align-items:center}
    .section-title{margin-top:18px; font-size:14px; font-weight:700; color:var(--ink)}

    /* ===== Modal de Resumen ===== */
    .modal-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; z-index:9999;
      backdrop-filter: blur(2px);
    }
    .modal-card{
      width:min(720px, calc(100vw - 32px));
      max-height:80vh; overflow:auto;
      background:var(--card); border:1px solid rgba(255,255,255,.1);
      border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.4);
    }
    .modal-head{display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08)}
    .modal-title{margin:0; font-size:16px}
    .modal-body{padding:8px 16px 4px}
    .modal-actions{display:flex; gap:10px; justify-content:flex-end; padding:12px 16px; border-top:1px solid rgba(255,255,255,.08)}
    .qalist{list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px}
    .qaitem{padding:10px 12px; border:1px solid rgba(255,255,255,.08); border-radius:12px; background:#0f1729}
    .q{font-weight:600; font-size:13px; color:var(--muted)}
    .a{font-size:14px; color:var(--ink); margin-top:2px; word-break:break-word}
    .iconbtn{cursor:pointer; border:0; background:transparent; color:var(--ink); font-size:20px; line-height:1}
    .iconbtn:hover{opacity:.85}

    /* Imprimir solo el modal */
    @media print{
      body>*:not(#summaryOverlay){display:none !important}
      #summaryOverlay{display:block !important; position:static; backdrop-filter:none; background:none}
      .modal-card{box-shadow:none; border:0; width:auto; max-height:none}
      .modal-actions{display:none}
    }
  </style>
</head>
<body>
  <header><h1>Sotelo Tramites Visa</h1></header>

  <div class="wrap">
    <div class="card">
      <!-- Nombres / Apellidos -->
      <div class="grid cols-2">
        <div>
          <label>Nombres</label>
          <input id="GIVEN_NAME" class="upcase" type="text" placeholder="EJ.: JUAN MIGUEL" />
        </div>
        <div>
          <label>Apellidos</label>
          <input id="SURNAME" class="upcase" type="text" placeholder="EJ.: FERNANDEZ GARCIA" />
        </div>
      </div>

      <!-- Nombre completo (requisito para guardar) -->
      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label>Nombre completo en alfabeto nativo</label>
          <input id="FULL_NAME_NATIVE" type="text" placeholder="(Nombres y Apellidos)" />
        </div>
        <div class="row hidden" aria-hidden="true" style="align-items:flex-end">
          <label style="visibility:hidden">NA</label>
          <div class="row">
            <input id="FULL_NAME_NATIVE_NA" type="checkbox" />
            <span class="muted">&nbsp;Does Not Apply / Technology Not Available</span>
          </div>
        </div>
      </div>

      <!-- Ocultos por defecto -->
      <div class="grid cols-2 hidden" aria-hidden="true" style="margin-top:10px">
        <div>
          <label>¿Ha usado otros nombres?</label>
          <select id="OTHER_NAMES">
            <option value="">- Seleccione -</option>
            <option value="Y">Yes</option>
            <option value="N" selected>No</option>
          </select>
        </div>
        <div>
          <label>¿Tiene “telecode” para su nombre?</label>
          <select id="TELECODE">
            <option value="">- Seleccione -</option>
            <option value="Y">Yes</option>
            <option value="N" selected>No</option>
          </select>
        </div>
      </div>

      <!-- Sexo / Estado civil -->
      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label>Sexo</label>
          <select id="SEX">
            <option value="">- Seleccione -</option>
            <option value="MALE">MASCULINO</option>
            <option value="FEMALE">FEMENINO</option>
          </select>
        </div>
        <div>
          <label>Estado civil</label>
          <select id="MARITAL">
            <option value="">- Seleccione -</option>
            <option value="MARRIED">CASADO/A</option>
            <option value="COMMON LAW MARRIAGE">UNIÓN LIBRE</option>
            <option value="CIVIL UNION/DOMESTIC PARTNERSHIP">UNIÓN CIVIL / PAREJA DOMÉSTICA</option>
            <option value="SINGLE">SOLTERO/A</option>
            <option value="WIDOWED">VIUDO/A</option>
            <option value="DIVORCED">DIVORCIADO/A</option>
            <option value="LEGALLY SEPARATED">SEPARADO/A LEGALMENTE</option>
            <option value="OTHER">OTRO</option>
          </select>
        </div>
      </div>

      <!-- Fecha de nacimiento -->
      <div class="row" style="margin-top:10px; gap:12px; align-items:flex-end; flex-wrap:nowrap">
        <div style="flex:1; min-width:0">
          <label>Fecha de nacimiento — Día (DD)</label>
          <select id="DOB_DAY">
            <option value=""></option>
            <option>01</option><option>02</option><option>03</option><option>04</option><option>05</option>
            <option>06</option><option>07</option><option>08</option><option>09</option><option>10</option>
            <option>11</option><option>12</option><option>13</option><option>14</option><option>15</option>
            <option>16</option><option>17</option><option>18</option><option>19</option><option>20</option>
            <option>21</option><option>22</option><option>23</option><option>24</option><option>25</option>
            <option>26</option><option>27</option><option>28</option><option>29</option><option>30</option>
            <option>31</option>
          </select>
        </div>
        <div style="flex:1; min-width:0">
          <label>Mes (MMM)</label>
          <select id="DOB_MONTH">
            <option value=""></option>
            <option>JAN</option><option>FEB</option><option>MAR</option><option>APR</option><option>MAY</option>
            <option>JUN</option><option>JUL</option><option>AUG</option><option>SEP</option><option>OCT</option>
            <option>NOV</option><option>DEC</option>
          </select>
        </div>
        <div style="flex:1; min-width:0">
          <label>Año (YYYY)</label>
          <input id="DOB_YEAR" type="text" placeholder="1984" maxlength="4" />
        </div>
      </div>

      <!-- Lugar de nacimiento -->
      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label>Ciudad de nacimiento</label>
          <input id="POB_CITY" class="upcase" type="text" placeholder="EJ.: HERMOSILLO" />
        </div>
        <div>
          <label>Estado/Provincia</label>
          <input id="POB_STATE_PROVINCE" class="upcase" type="text" placeholder="EJ.: SONORA" />
          <div class="row hidden" aria-hidden="true" style="margin-top:6px">
            <input id="POB_STATE_NA" type="checkbox" />
            <span class="muted">&nbsp;Does Not Apply</span>
          </div>
        </div>
      </div>

      <!-- País/Región (del lugar de nacimiento; catálogo MX como en original) -->
      <div style="margin-top:10px">
        <label>Country/Region</label>
        <select id="POB_CNTRY">
          <option value="">- Seleccione -</option>
          <option value="AGS">MEXICO - AGUASCALIENTES</option>
          <option value="BC">MEXICO - BAJA CALIFORNIA NORTE</option>
          <option value="BCSR">MEXICO - BAJA CALIFORNIA SUR</option>
          <option value="CAMP">MEXICO - CAMPECHE</option>
          <option value="CHIS">MEXICO - CHIAPAS</option>
          <option value="CHIH">MEXICO - CHIHUAHUA</option>
          <option value="COAH">MEXICO - COAHUILA</option>
          <option value="COLI">MEXICO - COLIMA</option>
          <option value="DF">MEXICO - DISTRITO FEDERAL</option>
          <option value="DGO">MEXICO - DURANGO</option>
          <option value="GTO">MEXICO - GUANAJUATO</option>
          <option value="GRO">MEXICO - GUERRERO</option>
          <option value="HGO">MEXICO - HIDALGO</option>
          <option value="JAL">MEXICO - JALISCO</option>
          <option value="MCH">MEXICO - MICHOACAN</option>
          <option value="MOR">MEXICO - MORELOS</option>
          <option value="NAY">MEXICO - NAYARIT</option>
          <option value="NL">MEXICO - NUEVO LEON</option>
          <option value="OAX">MEXICO - OAXACA</option>
          <option value="PUE">MEXICO - PUEBLA</option>
          <option value="QRO">MEXICO - QUERETARO</option>
          <option value="QROO">MEXICO - QUINTANA ROO</option>
          <option value="SLP">MEXICO - SAN LUIS POTOSI</option>
          <option value="SIN">MEXICO - SINALOA</option>
          <option value="SON">MEXICO - SONORA</option>
          <option value="MXCO">MEXICO - STATE OF MEXICO</option>
          <option value="TAB">MEXICO - TABASCO</option>
          <option value="TAMP">MEXICO - TAMAULIPAS</option>
          <option value="TLAX">MEXICO - TLAXCALA</option>
          <option value="VER">MEXICO - VERACRUZ</option>
          <option value="YUC">MEXICO - YUCATAN</option>
          <option value="ZAC">MEXICO - ZACATECAS</option>
        </select>
      </div>

      <!-- ===================== NUEVAS PREGUNTAS (en español + LATAM) ===================== -->
      <div class="section-title">Nacionalidades y residencia</div>

      <!-- Nacionalidad (origen) -->
      <div style="margin-top:8px">
        <label>País/Región de origen (Nacionalidad)</label>
        <select id="NATL">
          <option value="">- Seleccione -</option>
          <option value="ARG">Argentina</option>
          <option value="BOL">Bolivia</option>
          <option value="BRA">Brasil</option>
          <option value="CHL">Chile</option>
          <option value="COL">Colombia</option>
          <option value="CRI">Costa Rica</option>
          <option value="CUB">Cuba</option>
          <option value="DOM">República Dominicana</option>
          <option value="ECU">Ecuador</option>
          <option value="SLV">El Salvador</option>
          <option value="GTM">Guatemala</option>
          <option value="HND">Honduras</option>
          <option value="MEX">México</option>
          <option value="NIC">Nicaragua</option>
          <option value="PAN">Panamá</option>
          <option value="PRY">Paraguay</option>
          <option value="PER">Perú</option>
          <option value="URY">Uruguay</option>
          <option value="VEN">Venezuela</option>
          <option value="OTHER">Otro</option>
        </select>
      </div>

      <!-- ¿Tiene/tuvo otra nacionalidad? -->
      <div style="margin-top:10px">
        <label>¿Tiene o ha tenido alguna otra nacionalidad además de la anterior?</label>
        <div class="radio-group">
          <label><input type="radio" name="OTHER_NATL_IND" value="Y"> Sí</label>
          <label><input type="radio" name="OTHER_NATL_IND" value="N" checked> No</label>
        </div>
        <div id="OTHER_NATL_WRAPPER" class="grid cols-1 hidden" style="margin-top:8px">
          <div>
            <label>Otra(s) nacionalidad(es)</label>
            <textarea id="OTHER_NATL_LIST" placeholder="Ej.: ESPAÑA, ITALIA (separadas por coma)"></textarea>
            <span class="hint">Escriba una o varias nacionalidades separadas por coma.</span>
          </div>
        </div>
      </div>

      <!-- ¿Residente permanente de otro país? -->
      <div style="margin-top:10px">
        <label>¿Es residente permanente de algún país/región distinto al de su nacionalidad?</label>
        <div class="radio-group">
          <label><input type="radio" name="PERM_RES_OTHER_IND" value="Y"> Sí</label>
          <label><input type="radio" name="PERM_RES_OTHER_IND" value="N" checked> No</label>
        </div>
        <div id="PERM_RES_CNTRY_WRAPPER" class="grid cols-1 hidden" style="margin-top:8px">
          <div>
            <label>País/Región de residencia permanente</label>
            <select id="PERM_RES_CNTRY">
              <option value="">- Seleccione -</option>
              <option value="ARG">Argentina</option>
              <option value="BOL">Bolivia</option>
              <option value="BRA">Brasil</option>
              <option value="CHL">Chile</option>
              <option value="COL">Colombia</option>
              <option value="CRI">Costa Rica</option>
              <option value="CUB">Cuba</option>
              <option value="DOM">República Dominicana</option>
              <option value="ECU">Ecuador</option>
              <option value="SLV">El Salvador</option>
              <option value="GTM">Guatemala</option>
              <option value="HND">Honduras</option>
              <option value="MEX">México</option>
              <option value="NIC">Nicaragua</option>
              <option value="PAN">Panamá</option>
              <option value="PRY">Paraguay</option>
              <option value="PER">Perú</option>
              <option value="URY">Uruguay</option>
              <option value="VEN">Venezuela</option>
              <option value="OTHER">Otro</option>
            </select>
          </div>
        </div>
      </div>

      <div class="section-title">Números de identificación</div>

      <!-- National Identification Number -->
      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label>CURP</label>
          <input id="NATIONAL_ID" type="text" placeholder="CURP" />
          <div class="row" style="margin-top:6px">
            <input id="NATIONAL_ID_NA" type="checkbox" />
            <span class="muted">&nbsp;No aplica</span>
          </div>
        </div>
        <!-- SSN (3-2-4) -->
        <div>
          <label>Número de Seguro Social de EE.UU. (SSN)</label>
          <div class="row" style="flex-wrap:nowrap">
            <input id="SSN_1" type="text" inputmode="numeric" maxlength="3" placeholder="123" style="width:70px" />
            <span>-</span>
            <input id="SSN_2" type="text" inputmode="numeric" maxlength="2" placeholder="45" style="width:60px" />
            <span>-</span>
            <input id="SSN_3" type="text" inputmode="numeric" maxlength="4" placeholder="6789" style="width:80px" />
          </div>
          <div class="row" style="margin-top:6px">
            <input id="SSN_NA" type="checkbox" />
            <span class="muted">&nbsp;No aplica</span>
          </div>
        </div>
      </div>

      <!-- Taxpayer ID -->
      <div style="margin-top:10px">
        <label>Número de contribuyente de EE.UU. (ITIN/EIN)</label>
        <input id="TAX_ID" type="text" placeholder="ITIN/EIN (si aplica)" />
        <div class="row" style="margin-top:6px">
          <input id="TAX_ID_NA" type="checkbox" />
          <span class="muted">&nbsp;No aplica</span>
        </div>
      </div>
      <!-- =================== FIN NUEVAS PREGUNTAS =================== -->

      <!-- Subir archivos -->
      <div style="margin-top:14px">
        <label>Sube tus documentos (PDF, imágenes, etc.)</label>
        <!-- Candado de inicio -->
        <input id="fileInput" type="file" multiple disabled />
        <span id="uploadStatus" class="hint"></span>
        <div id="uploadList" class="up-list"></div>
      </div>

      <div class="footer">
        <button id="clear" class="btn ghost">Limpiar</button>
        <button id="summaryBtn" class="btn ghost">Ver resumen</button>
        <!-- Candado de inicio -->
        <button id="finish" class="btn primary" disabled>He terminado</button>
        <span id="msg" class="hint"></span>
      </div>
    </div>
  </div>

  <!-- ===== Ventana emergente: Resumen ===== -->
  <div id="summaryOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="summaryTitle">
      <div class="modal-head">
        <h3 id="summaryTitle" class="modal-title">Resumen del formulario</h3>
        <button id="summaryClose" class="iconbtn" aria-label="Cerrar">&times;</button>
      </div>
      <div class="modal-body">
        <ul id="summaryList" class="qalist"></ul>
      </div>
      <div class="modal-actions">
        <button id="summaryPrint" class="btn ghost">Imprimir / Guardar PDF</button>
        <button id="summaryClose2" class="btn primary">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const endpoint="https://script.google.com/macros/s/AKfycbxYeLAcfko8GGql3vlFMgE8tPGk2sycn9NDj_1QQACf_Op3u3Xjhz6A_0AhyvmJYo0N/exec";

      // ======== NUEVO: Persistencia local (no perder al reabrir) ========
      const CACHE_KEY = "soteloVisaForm.v1";
      let cacheTimer=null;
      function by(id){ return document.getElementById(id); }
      function scheduleLocalSave(){ clearTimeout(cacheTimer); cacheTimer = setTimeout(saveLocalCache, 400); }
      function saveLocalCache(){
        try{
          const data = gather();
          const cache = { updatedAt: new Date().toISOString(), data };
          localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
        }catch(e){ /* almacenamiento puede fallar en modo privado */ }
      }
      function loadLocalCache(){
        try{
          const raw = localStorage.getItem(CACHE_KEY);
          if(!raw) return null;
          const obj = JSON.parse(raw);
          return (obj && obj.data) ? obj : null;
        }catch(e){ return null; }
      }
      function setSelectByText(id, text){
        const el = by(id); if(!el || !text) return;
        const target = text.trim().toUpperCase();
        for(const opt of el.options){
          const t = (opt.textContent || "").trim().toUpperCase();
          if(t === target){ el.value = opt.value; return; }
        }
      }
      function applyDataToUI(d){
        if(!d) return;
        const set = (id, v)=>{ const el=by(id); if(el!=null) el.value = (v==null?"":String(v)); };
        const setSel = (id, v)=>{ const el=by(id); if(el!=null) el.value = (v||""); };
        const setCB = (id, v)=>{ const el=by(id); if(el!=null) el.checked = !!v; };
        const setRadio = (name, v)=>{ const r=document.querySelector(`input[name="${name}"][value="${v||"N"}"]`); if(r) r.checked=true; };

        set("GIVEN_NAME", d.GIVEN_NAME);
        set("SURNAME", d.SURNAME);
        set("FULL_NAME_NATIVE", d.FULL_NAME_NATIVE);
        setCB("FULL_NAME_NATIVE_NA", d.FULL_NAME_NATIVE_NA);

        setSel("SEX", d.SEX);
        setSel("MARITAL", d.MARITAL);

        const dd = d.DOB_DAY ? String(d.DOB_DAY).padStart(2,"0") : "";
        setSel("DOB_DAY", dd);
        setSel("DOB_MONTH", d.DOB_MONTH);
        set("DOB_YEAR", d.DOB_YEAR);

        set("POB_CITY", d.POB_CITY);
        set("POB_STATE_PROVINCE", d.POB_STATE_PROVINCE);
        setCB("POB_STATE_NA", d.POB_STATE_NA);
        setSelectByText("POB_CNTRY", d.POB_CNTRY);

        setSelectByText("NATL", d.NATL);
        setRadio("OTHER_NATL_IND", d.OTHER_NATL_IND || "N");
        set("OTHER_NATL_LIST", d.OTHER_NATL_LIST || "");
        setRadio("PERM_RES_OTHER_IND", d.PERM_RES_OTHER_IND || "N");
        setSelectByText("PERM_RES_CNTRY", d.PERM_RES_CNTRY || "");

        set("NATIONAL_ID", d.NATIONAL_ID || "");
        setCB("NATIONAL_ID_NA", d.NATIONAL_ID_NA);

        setCB("SSN_NA", d.SSN_NA);
        if(d.SSN && !d.SSN_NA){
          const parts = String(d.SSN).split("-");
          set("SSN_1", parts[0] || "");
          set("SSN_2", parts[1] || "");
          set("SSN_3", parts[2] || "");
        }

        set("TAX_ID", d.TAX_ID || "");
        setCB("TAX_ID_NA", d.TAX_ID_NA);
      }
      // ======== FIN Persistencia local ========

      let lastData="";
      let STATUS="EN_PROGRESO";
      let FINISHED_AT=null;

      // Estado de subidas
      let uploading=false;
      let uploadsTotal=0, uploadsDone=0, uploadsFailed=0;

      function up(v){ return (v||"").toString().trim().toUpperCase(); }
      function setMsg(t){ const m=by("msg"); if(m) m.textContent=t||""; }
      function setUploadStatus(t){ const u=by("uploadStatus"); if(u) u.textContent=t||""; }

      /* UI de progreso */
      function createProgressItem(name){
        const list = by("uploadList");
        const item = document.createElement("div");
        item.className = "up-item";
        item.innerHTML = `
          <div class="up-head">
            <span class="up-name" title="\${name}">\${name}</span>
            <span class="up-pct">0%</span>
          </div>
          <div class="up-bar"><span class="up-fill"></span></div>
        `.replaceAll("${name}", name);
        list.appendChild(item);
        const pct = item.querySelector(".up-pct");
        const fill = item.querySelector(".up-fill");
        return {
          set(p){
            const v = Math.max(0, Math.min(100, Math.round(p)));
            pct.textContent = v + "%";
            fill.style.width = v + "%";
          },
          ok(){ item.classList.remove("err"); item.classList.add("ok"); this.set(100); pct.textContent="100%"; },
          err(){ item.classList.remove("ok"); item.classList.add("err"); }
        };
      }

      // Solo dígitos en SSN
      function digitsOnly(el){ el.value = (el.value||"").replace(/\D+/g,""); }

      function gather(){
        const daySel = by("DOB_DAY");
        const monthSel = by("DOB_MONTH");
        const countrySel = by("POB_CNTRY");

        const dRaw = (daySel && daySel.value || "").trim();
        const dobMonth = (monthSel && monthSel.value || "").trim();

        let pobText = "";
        if(countrySel && countrySel.options && countrySel.selectedIndex >= 0){
          const opt = countrySel.options[countrySel.selectedIndex];
          pobText = (opt && opt.textContent ? opt.textContent.trim() : "");
        }

        // Nacionalidad seleccionada (texto visible)
        let natlText = "";
        const natlSel = by("NATL");
        if(natlSel && natlSel.options && natlSel.selectedIndex >= 0){
          natlText = (natlSel.options[natlSel.selectedIndex].textContent || "").trim();
        }

        // Respuestas Sí/No
        const otherNatlInd = (document.querySelector('input[name="OTHER_NATL_IND"]:checked')||{}).value || "N";
        const permResInd = (document.querySelector('input[name="PERM_RES_OTHER_IND"]:checked')||{}).value || "N";

        // País de residencia permanente (texto)
        let permResText = "";
        const permSel = by("PERM_RES_CNTRY");
        if(permSel && permSel.options && permSel.selectedIndex >= 0){
          permResText = (permSel.options[permSel.selectedIndex].textContent || "").trim();
        }

        // SSN (si aplica)
        const ssnNA = !!(by("SSN_NA") && by("SSN_NA").checked);
        const ssn1 = by("SSN_1") ? by("SSN_1").value.trim() : "";
        const ssn2 = by("SSN_2") ? by("SSN_2").value.trim() : "";
        const ssn3 = by("SSN_3") ? by("SSN_3").value.trim() : "";
        const ssn = ssnNA ? "" : [ssn1, ssn2, ssn3].filter(Boolean).join("-");

        return {
          // Datos existentes
          SURNAME: up(by("SURNAME") && by("SURNAME").value),
          GIVEN_NAME: up(by("GIVEN_NAME") && by("GIVEN_NAME").value),
          FULL_NAME_NATIVE: (by("FULL_NAME_NATIVE") && by("FULL_NAME_NATIVE").value || "").trim(),
          FULL_NAME_NATIVE_NA: !!(by("FULL_NAME_NATIVE_NA") && by("FULL_NAME_NATIVE_NA").checked),
          OTHER_NAMES: (by("OTHER_NAMES") && by("OTHER_NAMES").value) || "",
          TELECODE: (by("TELECODE") && by("TELECODE").value) || "",
          SEX: ((by("SEX") && by("SEX").value) || "").toUpperCase(),
          MARITAL: ((by("MARITAL") && by("MARITAL").value) || "").toUpperCase(),
          DOB_DAY: (dRaw.replace(/^0+/, "") || ""),
          DOB_MONTH: dobMonth,
          DOB_YEAR: (by("DOB_YEAR") && by("DOB_YEAR").value || "").trim(),
          POB_CITY: up(by("POB_CITY") && by("POB_CITY").value),
          POB_STATE_PROVINCE: up(by("POB_STATE_PROVINCE") && by("POB_STATE_PROVINCE").value),
          POB_STATE_NA: !!(by("POB_STATE_NA") && by("POB_STATE_NA").checked),
          POB_CNTRY: pobText,

          // Nuevos (Personal 2, en español)
          NATL: natlText,                                   // Nacionalidad (texto visible)
          OTHER_NATL_IND: otherNatlInd,                     // S/N (Y/N)
          OTHER_NATL_LIST: (by("OTHER_NATL_LIST") && by("OTHER_NATL_LIST").value || "").trim(),
          PERM_RES_OTHER_IND: permResInd,                   // S/N (Y/N)
          PERM_RES_CNTRY: permResText,                      // País residencia permanente
          NATIONAL_ID: (by("NATIONAL_ID") && by("NATIONAL_ID").value || "").trim(),
          NATIONAL_ID_NA: !!(by("NATIONAL_ID_NA") && by("NATIONAL_ID_NA").checked),
          SSN: ssn,
          SSN_NA: ssnNA,
          TAX_ID: (by("TAX_ID") && by("TAX_ID").value || "").trim(),
          TAX_ID_NA: !!(by("TAX_ID_NA") && by("TAX_ID_NA").checked),
        };
      }

      /* ===== Utilidades de resumen ===== */
      const MONTH_ES = {JAN:"ENE", FEB:"FEB", MAR:"MAR", APR:"ABR", MAY:"MAY", JUN:"JUN", JUL:"JUL", AUG:"AGO", SEP:"SEP", OCT:"OCT", NOV:"NOV", DEC:"DIC"};
      function mapSex(code){ return code==="MALE"?"MASCULINO":(code==="FEMALE"?"FEMENINO":"—"); }
      function mapMarital(code){
        const m={
          "MARRIED":"CASADO/A","COMMON LAW MARRIAGE":"UNIÓN LIBRE",
          "CIVIL UNION/DOMESTIC PARTNERSHIP":"UNIÓN CIVIL / PAREJA DOMÉSTICA",
          "SINGLE":"SOLTERO/A","WIDOWED":"VIUDO/A","DIVORCED":"DIVORCIADO/A",
          "LEGALLY SEPARATED":"SEPARADO/A LEGALMENTE","OTHER":"OTRO"
        };
        return m[code] || "—";
      }
      function yn(v){ return v==="Y"?"Sí":(v==="N"?"No":"—"); }
      function nz(v){ v=(v||"").trim(); return v? v : "—"; }
      function fmtDOB(d,m,y){
        const mm = MONTH_ES[(m||"").toUpperCase()] || "";
        const dd = (d||"").toString().padStart(2,"0");
        const yy = (y||"").toString();
        return (dd||mm||yy) ? [dd, mm, yy].filter(Boolean).join(" ") : "—";
      }

      function buildSummaryPairs(d){
        const pairs = [
          {q:"Nombres", a:nz(d.GIVEN_NAME)},
          {q:"Apellidos", a:nz(d.SURNAME)},
          {q:"Nombre completo (alfabeto nativo)", a:nz(d.FULL_NAME_NATIVE)},
          {q:"Sexo", a:mapSex(d.SEX)},
          {q:"Estado civil", a:mapMarital(d.MARITAL)},
          {q:"Fecha de nacimiento", a:fmtDOB(d.DOB_DAY,d.DOB_MONTH,d.DOB_YEAR)},
          {q:"Ciudad de nacimiento", a:nz(d.POB_CITY)},
          {q:"Estado/Provincia de nacimiento", a:nz(d.POB_STATE_PROVINCE)},
          {q:"País/Región de nacimiento", a:nz(d.POB_CNTRY)},
          {q:"Nacionalidad (origen)", a:nz(d.NATL)},
          {q:"¿Tiene/tuvo otra nacionalidad?", a:yn(d.OTHER_NATL_IND)}
        ];

        if(d.OTHER_NATL_IND==="Y"){
          pairs.push({q:"Otra(s) nacionalidad(es)", a:nz(d.OTHER_NATL_LIST)});
        }

        pairs.push({q:"¿Residente permanente de otro país?", a:yn(d.PERM_RES_OTHER_IND)});
        if(d.PERM_RES_OTHER_IND==="Y"){
          pairs.push({q:"País de residencia permanente", a:nz(d.PERM_RES_CNTRY)});
        }

        pairs.push({
          q:"Número de identificación nacional",
          a: d.NATIONAL_ID_NA ? "No aplica" : nz(d.NATIONAL_ID)
        });

        pairs.push({
          q:"Número de Seguro Social de EE.UU. (SSN)",
          a: d.SSN_NA ? "No aplica" : nz(d.SSN)
        });

        pairs.push({
          q:"Número de contribuyente de EE.UU. (ITIN/EIN)",
          a: d.TAX_ID_NA ? "No aplica" : nz(d.TAX_ID)
        });

        return pairs;
      }

      function renderSummary(listEl, pairs){
        listEl.innerHTML = "";
        pairs.forEach(({q,a})=>{
          const li = document.createElement("li");
          li.className = "qaitem";
          const dq = document.createElement("div");
          dq.className = "q";
          dq.textContent = q;
          const da = document.createElement("div");
          da.className = "a";
          da.textContent = a;
          li.appendChild(dq);
          li.appendChild(da);
          listEl.appendChild(li);
        });
      }

      function showSummary(){
        const data = gather();
        const pairs = buildSummaryPairs(data);
        renderSummary(by("summaryList"), pairs);
        const ov = by("summaryOverlay");
        if(ov){ ov.style.display="flex"; ov.setAttribute("aria-hidden","false"); }
      }
      function hideSummary(){
        const ov = by("summaryOverlay");
        if(ov){ ov.style.display="none"; ov.setAttribute("aria-hidden","true"); }
      }

      function hasMinimum(data){
        return !!(data.GIVEN_NAME && data.SURNAME && data.FULL_NAME_NATIVE);
      }

      function toggleLock(){
        const d=gather();
        const ok=hasMinimum(d);
        const fi=by("fileInput");
        const finishBtn=by("finish");
        if(fi) fi.disabled = uploading || !ok;
        if(finishBtn) finishBtn.disabled = uploading || !ok;
        setMsg(ok ? "" : "Escribe Nombres, Apellidos y Nombre completo para habilitar subida y envío.");
      }

      async function saveIfChanged(force=false){
        const base=gather();
        if(!hasMinimum(base)){
          setMsg("Escribe Nombres, Apellidos y Nombre completo para comenzar a guardar.");
          toggleLock();
          return;
        }
        base.STATUS=STATUS;
        if(FINISHED_AT) base.FINISHED_AT=FINISHED_AT;
        const payload=JSON.stringify(base);
        if(!force && payload===lastData) return;
        lastData=payload;
        try{
          await fetch(endpoint,{method:"POST",body:payload,headers:{"Content-Type":"text/plain"}});
          setMsg((STATUS==="FINALIZADO")?"Guardado (finalizado — editable).":"Guardado automático.");
        }catch(e){
          setMsg("No se pudo guardar ahora. Se reintentará.");
          console.warn("Error al guardar:", e);
        }
      }

      function fileToBase64(file, onProgress){
        return new Promise((res,rej)=>{
          const fr=new FileReader();
          fr.onerror=()=>rej(new Error("No se pudo leer "+file.name));
          fr.onprogress=(e)=>{ if(e.lengthComputable && typeof onProgress==="function"){ onProgress(e.loaded / e.total); } };
          fr.onload=()=>{
            const s=String(fr.result||"");
            res({base64:s.split(",")[1]||"", mime:file.type||"application/octet-stream"});
          };
          fr.readAsDataURL(file);
        });
      }

      async function uploadFilesSequential(files){
        if(uploading){ alert("Ya hay una carga en curso. Espera a que termine."); return; }

        const d=gather();
        if(!hasMinimum(d)){
          alert("Primero escribe Nombres, Apellidos y Nombre completo.");
          const fi=by("fileInput"); if(fi) fi.value="";
          toggleLock();
          return;
        }

        uploading=true;
        uploadsTotal=files.length;
        uploadsDone=0;
        uploadsFailed=0;

        const beforeUnload=(e)=>{ if(uploading){ e.preventDefault(); e.returnValue=""; } };
        window.addEventListener("beforeunload", beforeUnload);

        // Deshabilita acciones durante la subida
        const fi=by("fileInput");
        const finishBtn=by("finish");
        if(fi) fi.disabled=true;
        if(finishBtn) finishBtn.disabled=true;

        // Limpia lista de progreso
        const list=by("uploadList"); if(list) list.innerHTML="";

        setUploadStatus(`Subiendo ${uploadsTotal} archivo(s)...`);

        for(const f of files){
          const prog = createProgressItem(f.name);
          try{
            const {base64, mime}=await fileToBase64(f, ratio => prog.set(ratio*80));
            prog.set(85);
            const payload={
              MODE:"UPLOAD_B64",
              GIVEN_NAME:d.GIVEN_NAME,
              SURNAME:d.SURNAME,
              FULL_NAME_NATIVE:d.FULL_NAME_NATIVE,
              file:{ name:f.name, type:mime, data:base64 }
            };
            const r=await fetch(endpoint,{method:"POST",body:JSON.stringify(payload),headers:{"Content-Type":"text/plain"}});
            const t=await r.text();
            uploadsDone++;
            prog.ok();
            setUploadStatus(`(${uploadsDone}/${uploadsTotal}) ${f.name} → ${t}`);
          }catch(err){
            uploadsFailed++;
            prog.err();
            console.warn(err);
            setUploadStatus(`Error con "${f.name}" (${uploadsDone}/${uploadsTotal}).`);
          }
        }

        uploading=false;
        window.removeEventListener("beforeunload", beforeUnload);
        // Rehabilita según candado
        toggleLock();
        if(fi){ fi.value=""; }

        if(uploadsFailed===0){
          setUploadStatus(`Subidas completas (${uploadsDone}/${uploadsTotal}).`);
        }else{
          setUploadStatus(`Terminó con errores: ${uploadsFailed} de ${uploadsTotal} fallidas.`);
        }
      }

      // Mostrar/Ocultar secciones según radios y NA
      function refreshConditional(){
        const otherNatl = (document.querySelector('input[name="OTHER_NATL_IND"]:checked')||{}).value === "Y";
        const permRes = (document.querySelector('input[name="PERM_RES_OTHER_IND"]:checked')||{}).value === "Y";
        const otherWrap = by("OTHER_NATL_WRAPPER");
        const permWrap = by("PERM_RES_CNTRY_WRAPPER");
        if(otherWrap) otherWrap.classList.toggle("hidden", !otherNatl);
        if(permWrap) permWrap.classList.toggle("hidden", !permRes);

        const natIdNA = !!(by("NATIONAL_ID_NA") && by("NATIONAL_ID_NA").checked);
        if(by("NATIONAL_ID")){ by("NATIONAL_ID").disabled = natIdNA; if(natIdNA) by("NATIONAL_ID").value=""; }

        const ssnNA = !!(by("SSN_NA") && by("SSN_NA").checked);
        ["SSN_1","SSN_2","SSN_3"].forEach(id=>{
          const el=by(id); if(el){ el.disabled = ssnNA; if(ssnNA) el.value=""; }
        });

        const taxNA = !!(by("TAX_ID_NA") && by("TAX_ID_NA").checked);
        if(by("TAX_ID")){ by("TAX_ID").disabled = taxNA; if(taxNA) by("TAX_ID").value=""; }
      }

      // ========= Registro de eventos =========
      document.addEventListener("DOMContentLoaded", ()=>{
        // Restaurar borrador local si existe
        const cached = loadLocalCache();
        if(cached && cached.data){
          applyDataToUI(cached.data);
          refreshConditional();
          toggleLock();
          try{
            const d = new Date(cached.updatedAt);
            setMsg(`Borrador restaurado de este navegador (${d.toLocaleString()}).`);
          }catch(_){ setMsg("Borrador restaurado de este navegador."); }
        }

        ["GIVEN_NAME","SURNAME","FULL_NAME_NATIVE"].forEach(id=>{
          const el=by(id); if(el) el.addEventListener("input", ()=>{ toggleLock(); scheduleLocalSave(); });
        });

        // Guardar local en cualquier cambio de formulario
        document.addEventListener("input", (e)=>{
          if(e.target && (e.target.matches('input, textarea'))) scheduleLocalSave();
        }, true);
        document.addEventListener("change", (e)=>{
          if(e.target && (e.target.matches('input, select, textarea'))){
            refreshConditional();
            scheduleLocalSave();
          }
        }, true);

        // Radios y checkboxes nuevos
        document.querySelectorAll('input[name="OTHER_NATL_IND"]').forEach(r=>r.addEventListener("change", ()=>{ refreshConditional(); scheduleLocalSave(); }));
        document.querySelectorAll('input[name="PERM_RES_OTHER_IND"]').forEach(r=>r.addEventListener("change", ()=>{ refreshConditional(); scheduleLocalSave(); }));
        ["NATIONAL_ID_NA","SSN_NA","TAX_ID_NA"].forEach(id=>{
          const el=by(id); if(el) el.addEventListener("change", ()=>{ refreshConditional(); scheduleLocalSave(); });
        });

        // Validación numérica SSN
        ["SSN_1","SSN_2","SSN_3"].forEach(id=>{
          const el=by(id); if(el) el.addEventListener("input", ()=>{ digitsOnly(el); scheduleLocalSave(); });
        });

        // Botón Resumen
        const btnSum = by("summaryBtn");
        if(btnSum){ btnSum.addEventListener("click", showSummary); }
        const sumClose = by("summaryClose");
        const sumClose2 = by("summaryClose2");
        const sumPrint = by("summaryPrint");
        if(sumClose){ sumClose.addEventListener("click", hideSummary); }
        if(sumClose2){ sumClose2.addEventListener("click", hideSummary); }
        if(sumPrint){ sumPrint.addEventListener("click", ()=>window.print()); }
        // Cerrar al hacer click fuera de la tarjeta
        const overlay = by("summaryOverlay");
        if(overlay){
          overlay.addEventListener("click", (e)=>{ if(e.target===overlay) hideSummary(); });
        }

        refreshConditional();
        toggleLock();

        // Guardado automático remoto (cada 30s) y también a cache local
        setInterval(()=>{
          saveLocalCache();
          saveIfChanged(false);
        }, 30000);

        // Botón limpiar
        const clearBtn=by("clear");
        if(clearBtn){
          clearBtn.addEventListener("click", ()=>{
            document.querySelectorAll('input[type="text"]').forEach(i=>i.value='');
            document.querySelectorAll('select').forEach(s=>s.value='');
            document.querySelectorAll('textarea').forEach(t=>t.value='');
            // Restablecer radios/NA
            const rOther = document.querySelector('input[name="OTHER_NATL_IND"][value="N"]');
            if(rOther) rOther.checked = true;
            const rPerm = document.querySelector('input[name="PERM_RES_OTHER_IND"][value="N"]');
            if(rPerm) rPerm.checked = true;
            ["NATIONAL_ID_NA","SSN_NA","TAX_ID_NA"].forEach(id=>{ const el=by(id); if(el) el.checked=false; });
            refreshConditional();

            const fi=by("fileInput"); if(fi) { fi.value=''; }
            setMsg('');
            setUploadStatus('');
            const list=by("uploadList"); if(list) list.innerHTML="";
            STATUS="EN_PROGRESO"; FINISHED_AT=null;
            toggleLock();

            try{ localStorage.removeItem(CACHE_KEY); }catch(_){}
          });
        }

        // Botón finalizar (YA NO BLOQUEA CAMPOS)
        const finishBtn=by("finish");
        if(finishBtn){
          finishBtn.addEventListener("click", async ()=>{
            const d=gather();
            if(!hasMinimum(d)){
              alert("Primero escribe Nombres, Apellidos y Nombre completo.");
              toggleLock();
              return;
            }
            if(uploading){
              alert(`Todavía se están subiendo archivos (${uploadsDone}/${uploadsTotal}). Espera a que terminen para finalizar.`);
              return;
            }
            const ok = confirm("Vas a finalizar el formulario. Podrás seguir editando, quedará marcado como FINALIZADO. ¿Confirmas?");
            if(!ok) return;

            STATUS="FINALIZADO";
            if(!FINISHED_AT) FINISHED_AT=new Date().toISOString();

            saveLocalCache();
            await saveIfChanged(true);
            alert("Formulario finalizado. Puedes seguir editando (finalizado — editable).");
            toggleLock();
          });
        }

        // File input
        const fi=by("fileInput");
        if(fi){
          fi.addEventListener("change", async (e)=>{
            const files=e.target.files;
            if(!files || !files.length) return;
            await uploadFilesSequential(files);
          });
        }
      });
    })();
  </script>
</body>
</html>
