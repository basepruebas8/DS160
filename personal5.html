<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personal 5</title>
  <style>
    :root{
      color-scheme: light dark;
      --bg: #f6f7fb;
      --bg-grad: radial-gradient(1200px 600px at 10% -10%, #dfe7ff55, transparent 60%),
                 radial-gradient(800px 400px at 110% 10%, #ffe6d655, transparent 60%);
      --card: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --border: #e2e8f0;
      --accent: #2563eb;
      --accent-600: #1d4ed8;
      --accent-700: #1e40af;
      --ring: #93c5fd;
      --shadow: 0 10px 30px rgba(2, 8, 23, .08);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0b1220;
        --bg-grad: radial-gradient(1200px 600px at 10% -10%, #1d2a4e75, transparent 60%),
                   radial-gradient(800px 400px at 110% 10%, #4e2a1d75, transparent 60%);
        --card: #0f172a;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --border: #233044;
        --accent: #60a5fa;
        --accent-600: #3b82f6;
        --accent-700: #2563eb;
        --ring: #60a5fa;
        --shadow: 0 12px 36px rgba(0,0,0,.35);
      }
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      line-height: 1.45;
      color: var(--text);
      background: var(--bg);
      background-image: var(--bg-grad);
    }

    .wrap { max-width: 960px; margin: 32px auto; padding: 0 16px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 24px;
      box-shadow: var(--shadow);
      backdrop-filter: saturate(120%) blur(4px);
    }

    header h1 { font-size: 1.35rem; margin: 0 0 6px; letter-spacing: -.01em; }
    .subtle { color: var(--muted); font-size: .95rem; margin-bottom: 18px; }

    fieldset {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      margin: 16px 0;
      background: linear-gradient(180deg, rgba(148,163,184,.06), transparent 60%);
    }
    legend { font-weight: 700; padding: 0 10px; font-size: .98rem; }
    legend::after{
      content: ""; display: inline-block; width: 8px; height: 8px; margin-left: 8px; border-radius: 999px;
      background: var(--accent); box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 20%, transparent);
    }

    label { display: inline-block; margin: 8px 0 6px; font-weight: 600; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .grid-2 { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
    .inline { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

    input[type="text"], input[type="date"], input[type="number"], textarea, select {
      width: 100%; max-width: 560px; padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text);
      outline: none; transition: border-color .15s ease, box-shadow .15s ease, transform .06s ease; box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }
    input:focus, textarea:focus, select:focus {
      border-color: var(--accent); box-shadow: 0 0 0 3px color-mix(in oklab, var(--ring) 45%, transparent);
    }

    textarea { min-height: 90px; resize: vertical; }

    .help { font-size: .9rem; color: var(--muted); margin-top: 2px; }
    .note { font-size:.92rem; color:var(--muted); }

    .actions { margin-top: 18px; display: flex; gap: 12px; align-items: center; border-top: 1px dashed var(--border); padding-top: 16px; }
    button {
      padding: 10px 16px; border-radius: 12px; border: 1px solid var(--border); background: var(--card);
      cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 600;
      transition: transform .06s ease, box-shadow .15s ease, background .2s ease, border-color .15s ease;
    }
    button.primary { background: linear-gradient(180deg, var(--accent), var(--accent-600)); color: white; border-color: transparent; box-shadow: 0 6px 16px rgba(37,99,235,.35); }
    button.primary:hover { background: linear-gradient(180deg, var(--accent-600), var(--accent-700)); transform: translateY(-0.5px); }

    .list-item { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)) auto; gap:10px; align-items:end; }
    .dl-item   { display:grid; grid-template-columns: 1.1fr 1fr auto; gap:10px; align-items:end; }
    .remove { border-color:#ef4444; color:#ef4444; }
    .remove:hover{ background:#ef44441a; }
    .hide { display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>Solicitud de Visa de No Inmigrante en línea (DS-160)</h1>
        <div class="subtle">Sección: <strong>Viajes previos a EE. UU.</strong></div>
      </header>

      <form id="ds160-previousustravel" action="#" method="post" novalidate>
        <fieldset>
          <legend>Información de viajes previos a EE. UU.</legend>
          <p class="note">Nota: Proporcione la siguiente información sobre viajes previos a Estados Unidos. Responda de forma completa y precisa a todas las preguntas.</p>

          <!-- ¿Ha estado alguna vez en EE. UU.? -->
          <div class="row">
            <label>¿Ha estado alguna vez en los Estados Unidos?</label>
            <div class="inline" role="radiogroup" aria-label="Ha estado en EE. UU.">
              <label style="font-weight:400;">
                <input type="radio" name="PREV_US_TRAVEL_IND" value="Y" id="PrevTravelY" required> Sí
              </label>
              <label style="font-weight:400;">
                <input type="radio" name="PREV_US_TRAVEL_IND" value="N" id="PrevTravelN"> No
              </label>
            </div>
            <p class="help">Seleccione “Sí” si alguna vez ha estado físicamente en territorio de los Estados Unidos.</p>
          </div>

          <!-- Viajes previos (solo si Sí) -->
          <div id="TripsSection" class="hide">
            <fieldset>
              <legend>Viajes previos</legend>
              <div id="TripsList" class="row"></div>
              <div class="inline" style="margin-top:8px;">
                <button type="button" id="AddTripBtn">Agregar viaje</button>
              </div>
              <p class="help">Agregue cada visita a EE. UU. (si no recuerda la fecha exacta, use una aproximada).</p>
            </fieldset>

            <!-- Licencia de conducir de EE. UU. -->
            <fieldset>
              <legend>Licencia de conducir de EE. UU.</legend>
              <div class="row">
                <label>¿Posee o ha poseído una licencia de conducir de EE. UU.?</label>
                <div class="inline" role="radiogroup">
                  <label style="font-weight:400;">
                    <input type="radio" name="US_DL_IND" value="Y" id="DlY"> Sí
                  </label>
                  <label style="font-weight:400;">
                    <input type="radio" name="US_DL_IND" value="N" id="DlN"> No
                  </label>
                </div>
              </div>

              <!-- Lista de licencias (con desplegable de Estado) -->
              <div id="DlListBlock" class="row hide">
                <div id="DlList" class="row"></div>
                <div class="inline" style="margin-top:8px;">
                  <button type="button" id="AddDlBtn">Agregar licencia</button>
                </div>
                <p class="help">Indique cada licencia que haya tenido. <strong>Estado emisor</strong> es un <em>desplegable</em>.</p>
              </div>
            </fieldset>
          </div>
        </fieldset>

        <fieldset>
          <legend>Información de visas previas</legend>

          <!-- ¿Alguna vez le han otorgado una visa? -->
          <div class="row">
            <label>¿Alguna vez le han otorgado una visa para los Estados Unidos?</label>
            <div class="inline" role="radiogroup" aria-label="Visa de EE. UU. emitida">
              <label style="font-weight:400;">
                <input type="radio" name="PREV_VISA_IND" value="Y" id="PrevVisaY" required> Sí
              </label>
              <label style="font-weight:400;">
                <input type="radio" name="PREV_VISA_IND" value="N" id="PrevVisaN"> No
              </label>
            </div>
          </div>

          <!-- Detalle de visa (solo si Sí) -->
          <div id="PrevVisaBlock" class="hide">
            <div class="grid-2">
              <div>
                <label for="PREV_VISA_DATE">Fecha de la última visa emitida</label>
                <input type="date" id="PREV_VISA_DATE" name="PREV_VISA_DATE">
              </div>
              <div>
                <label for="PREV_VISA_NUMBER">Número de visa (si se conoce)</label>
                <input type="text" id="PREV_VISA_NUMBER" name="PREV_VISA_NUMBER" maxlength="20">
              </div>
            </div>

            <div class="row">
              <label>¿Solicita el mismo tipo de visa?</label>
              <div class="inline" role="radiogroup">
                <label style="font-weight:400;"><input type="radio" name="SAME_VISA_CLASS_IND" value="Y"> Sí</label>
                <label style="font-weight:400;"><input type="radio" name="SAME_VISA_CLASS_IND" value="N"> No</label>
              </div>
            </div>

            <div class="row">
              <label>¿Solicita en el mismo país donde se emitió su visa anterior y es ese país su principal residencia?</label>
              <div class="inline" role="radiogroup">
                <label style="font-weight:400;"><input type="radio" name="SAME_COUNTRY_IND" value="Y"> Sí</label>
                <label style="font-weight:400;"><input type="radio" name="SAME_COUNTRY_IND" value="N"> No</label>
              </div>
            </div>

            <div class="row">
              <label>¿Le han tomado huellas dactilares (ten-printed)?</label>
              <div class="inline" role="radiogroup">
                <label style="font-weight:400;"><input type="radio" name="TEN_PRINTED_IND" value="Y"> Sí</label>
                <label style="font-weight:400;"><input type="radio" name="TEN_PRINTED_IND" value="N"> No</label>
              </div>
            </div>

            <div class="row">
              <label>¿Alguna vez se ha perdido o le han robado una visa de EE. UU.?</label>
              <div class="inline" role="radiogroup">
                <label style="font-weight:400;"><input type="radio" name="VISA_LOST_IND" value="Y" id="VisaLostY"> Sí</label>
                <label style="font-weight:400;"><input type="radio" name="VISA_LOST_IND" value="N" id="VisaLostN"> No</label>
              </div>
            </div>

            <div id="VisaLostBlock" class="row hide">
              <div class="grid-2">
                <div>
                  <label for="VISA_LOST_YEAR">Año del incidente</label>
                  <select id="VISA_LOST_YEAR" name="VISA_LOST_YEAR"></select>
                </div>
                <div>
                  <label for="VISA_LOST_EXPL">Explicación</label>
                  <input type="text" id="VISA_LOST_EXPL" name="VISA_LOST_EXPL" maxlength="200">
                </div>
              </div>
            </div>

            <div class="row">
              <label>¿Alguna vez le han cancelado o revocado una visa de EE. UU.?</label>
              <div class="inline" role="radiogroup">
                <label style="font-weight:400;"><input type="radio" name="VISA_REVOKED_IND" value="Y" id="VisaRevY"> Sí</label>
                <label style="font-weight:400;"><input type="radio" name="VISA_REVOKED_IND" value="N" id="VisaRevN"> No</label>
              </div>
            </div>

            <div id="VisaRevBlock" class="row hide">
              <div class="grid-2">
                <div>
                  <label for="VISA_REVOKED_YEAR">Año del incidente</label>
                  <select id="VISA_REVOKED_YEAR" name="VISA_REVOKED_YEAR"></select>
                </div>
                <div>
                  <label for="VISA_REVOKED_EXPL">Explicación</label>
                  <input type="text" id="VISA_REVOKED_EXPL" name="VISA_REVOKED_EXPL" maxlength="200">
                </div>
              </div>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Negaciones / admisión</legend>
          <div class="row">
            <label>¿Alguna vez se le ha negado una visa estadounidense, la entrada a los EE. UU., o retiró su solicitud de admisión en un puerto de entrada?</label>
            <div class="inline" role="radiogroup" aria-label="Visa/Entrada negada o retiro de solicitud">
              <label style="font-weight:400;">
                <input type="radio" name="PREV_VISA_REFUSED_IND" value="Y" id="PrevRefusedY" required> Sí
              </label>
              <label style="font-weight:400;">
                <input type="radio" name="PREV_VISA_REFUSED_IND" value="N" id="PrevRefusedN"> No
              </label>
            </div>
          </div>

          <div id="RefusedBlock" class="row hide">
            <div class="grid-2">
              <div>
                <label for="REFUSED_YEAR">Año (aprox.)</label>
                <select id="REFUSED_YEAR" name="REFUSED_YEAR"></select>
              </div>
              <div>
                <label for="REFUSED_EXPL">Explique brevemente</label>
                <textarea id="REFUSED_EXPL" name="REFUSED_EXPL" maxlength="500" placeholder="Ej.: visa B1/B2 negada en Ciudad X por falta de lazos económicos."></textarea>
              </div>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Petición de inmigrante (USCIS)</legend>
          <div class="row">
            <label>¿Alguien ha presentado una petición de inmigrante a su favor ante el Servicio de Ciudadanía e Inmigración de los EE. UU. (USCIS)?</label>
            <div class="inline" role="radiogroup" aria-label="Petición de inmigrante (USCIS)">
              <label style="font-weight:400;">
                <input type="radio" name="IV_PETITION_IND" value="Y" id="IvPetitionY" required> Sí
              </label>
              <label style="font-weight:400;">
                <input type="radio" name="IV_PETITION_IND" value="N" id="IvPetitionN"> No
              </label>
            </div>
          </div>

          <div id="IvPetitionBlock" class="row hide">
            <div class="grid-2">
              <div>
                <label for="IV_PETITION_YEAR">Año (aprox.)</label>
                <select id="IV_PETITION_YEAR" name="IV_PETITION_YEAR"></select>
              </div>
              <div>
                <label for="IV_PETITION_EXPL">Explique (peticionario, tipo de petición si lo sabe)</label>
                <textarea id="IV_PETITION_EXPL" name="IV_PETITION_EXPL" maxlength="500" placeholder="Ej.: I-130 presentada por mi cónyuge ciudadano en 2021."></textarea>
              </div>
            </div>
          </div>
        </fieldset>

        <div class="actions">
          <button type="button" id="backBtn">Regresar</button>
          <button type="button" id="nextBtn" class="primary">Siguiente</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Navegación
    const BACK_URL = new URL('personal4.html', window.location.href).href;
    const NEXT_URL = new URL('personal6.html', window.location.href).href;

    // Persistencia local
    const STORAGE_PREFIX = 'ds160:';
    const FORM_ID = 'ds160-previousustravel';
    const TRIP_COUNT_KEY = STORAGE_PREFIX + FORM_ID + ':TRIP_COUNT';
    const DL_COUNT_KEY   = STORAGE_PREFIX + FORM_ID + ':DL_COUNT';

    function storageKey(field) {
      const idOrName = field.type === 'radio' ? field.name : (field.id || field.name);
      return STORAGE_PREFIX + FORM_ID + ':' + idOrName;
    }
    function saveField(field) {
      try {
        if (field.type === 'radio') {
          if (field.checked) localStorage.setItem(storageKey(field), field.value);
        } else {
          localStorage.setItem(storageKey(field), field.value);
        }
      } catch(e) {}
    }
    function restoreField(field) {
      try {
        const key = storageKey(field);
        const v = localStorage.getItem(key);
        if (v == null) return;
        if (field.type === 'radio') field.checked = (field.value === v);
        else field.value = v;
      } catch(e) {}
    }
    function autosave(form) {
      form.addEventListener('input', (e) => {
        const t = e.target;
        if (t && t.matches('input,select,textarea')) saveField(t);
      }, true);
      form.addEventListener('change', (e) => {
        const t = e.target;
        if (t && t.matches('input,select,textarea')) saveField(t);
      }, true);
    }

    // Año desplegable
    function fillYearSelect(sel, start=1970){
      const now = new Date().getFullYear();
      sel.innerHTML = '<option value="">- Año -</option>';
      for (let y=now; y>=start; y--){
        const opt = document.createElement('option');
        opt.value = String(y); opt.textContent = String(y);
        sel.appendChild(opt);
      }
    }

    // Estados de EE. UU. (desplegable)
    const US_STATES = [
      ["", "- Estado emisor -"],
      ["AL","Alabama"],["AK","Alaska"],["AZ","Arizona"],["AR","Arkansas"],["CA","California"],
      ["CO","Colorado"],["CT","Connecticut"],["DE","Delaware"],["FL","Florida"],["GA","Georgia"],
      ["HI","Hawái"],["ID","Idaho"],["IL","Illinois"],["IN","Indiana"],["IA","Iowa"],
      ["KS","Kansas"],["KY","Kentucky"],["LA","Luisiana"],["ME","Maine"],["MD","Maryland"],
      ["MA","Massachusetts"],["MI","Míchigan"],["MN","Minnesota"],["MS","Misisipi"],["MO","Misuri"],
      ["MT","Montana"],["NE","Nebraska"],["NV","Nevada"],["NH","Nuevo Hampshire"],["NJ","Nueva Jersey"],
      ["NM","Nuevo México"],["NY","Nueva York"],["NC","Carolina del Norte"],["ND","Dakota del Norte"],
      ["OH","Ohio"],["OK","Oklahoma"],["OR","Oregón"],["PA","Pensilvania"],["RI","Rhode Island"],
      ["SC","Carolina del Sur"],["SD","Dakota del Sur"],["TN","Tennessee"],["TX","Texas"],
      ["UT","Utah"],["VT","Vermont"],["VA","Virginia"],["WA","Washington"],["WV","Virginia Occidental"],
      ["WI","Wisconsin"],["WY","Wyoming"],["DC","Distrito de Columbia"],["PR","Puerto Rico"],
      ["GU","Guam"],["VI","Islas Vírgenes de EE. UU."],["AS","Samoa Americana"],["MP","Islas Marianas del Norte"]
    ];
    function stateSelect(){
      const s = document.createElement('select');
      s.name = 'US_DL_STATE';
      US_STATES.forEach(([v,t])=>{
        const o = document.createElement('option'); o.value=v; o.textContent=t; s.appendChild(o);
      });
      return s;
    }

    // DOM refs
    const form = document.getElementById(FORM_ID);

    const prevTravelY = document.getElementById('PrevTravelY');
    const prevTravelN = document.getElementById('PrevTravelN');
    const tripsSection = document.getElementById('TripsSection');
    const tripsList = document.getElementById('TripsList');
    const addTripBtn = document.getElementById('AddTripBtn');

    const dlY = document.getElementById('DlY');
    const dlN = document.getElementById('DlN');
    const dlListBlock = document.getElementById('DlListBlock');
    const dlList = document.getElementById('DlList');
    const addDlBtn = document.getElementById('AddDlBtn');

    const prevVisaY = document.getElementById('PrevVisaY');
    const prevVisaN = document.getElementById('PrevVisaN');
    const prevVisaBlock = document.getElementById('PrevVisaBlock');

    const visaLostY = document.getElementById('VisaLostY');
    const visaLostN = document.getElementById('VisaLostN');
    const visaLostBlock = document.getElementById('VisaLostBlock');
    const visaRevY = document.getElementById('VisaRevY');
    const visaRevN = document.getElementById('VisaRevN');
    const visaRevBlock = document.getElementById('VisaRevBlock');

    const refusedY = document.getElementById('PrevRefusedY');
    const refusedN = document.getElementById('PrevRefusedN');
    const refusedBlock = document.getElementById('RefusedBlock');

    const ivPetY = document.getElementById('IvPetitionY');
    const ivPetN = document.getElementById('IvPetitionN');
    const ivPetBlock = document.getElementById('IvPetitionBlock');

    // Helpers dinámicos
    function setRequired(el, on){ el.required = !!on; el.setCustomValidity(''); }

    function makeTripItem(){
      const wrap = document.createElement('div');
      wrap.className = 'list-item';

      const f1 = document.createElement('div');
      const l1 = document.createElement('label'); l1.textContent = 'Fecha de llegada';
      const d1 = document.createElement('input'); d1.type='date'; d1.name='TRIP_ARRIVAL_DATE'; d1.required = true;
      f1.appendChild(l1); f1.appendChild(d1);

      const f2 = document.createElement('div');
      const l2 = document.createElement('label'); l2.textContent = 'Fecha de salida';
      const d2 = document.createElement('input'); d2.type='date'; d2.name='TRIP_DEPART_DATE';
      f2.appendChild(l2); f2.appendChild(d2);

      const f3 = document.createElement('div');
      const l3 = document.createElement('label'); l3.textContent = 'Número I-94 (si aplica)';
      const t3 = document.createElement('input'); t3.type='text'; t3.name='TRIP_I94'; t3.maxLength=20;
      f3.appendChild(l3); f3.appendChild(t3);

      const f4 = document.createElement('div');
      const btn = document.createElement('button'); btn.type='button'; btn.className='remove'; btn.textContent='Eliminar';
      btn.addEventListener('click', ()=>{ tripsList.removeChild(wrap); saveTripCount(); refreshTripRemove(); });
      f4.appendChild(btn);

      wrap.appendChild(f1); wrap.appendChild(f2); wrap.appendChild(f3); wrap.appendChild(f4);

      return wrap;
    }
    function refreshTripRemove(){
      const items = [...tripsList.children];
      const hide = items.length <= 1;
      items.forEach(i => {
        const b = i.querySelector('button.remove'); if (b) b.style.visibility = hide ? 'hidden' : 'visible';
      });
    }
    function saveTripCount(){ localStorage.setItem(TRIP_COUNT_KEY, String(tripsList.children.length)); }
    function addTrip(){ const it = makeTripItem(); tripsList.appendChild(it); saveTripCount(); refreshTripRemove(); }

    function makeDlItem(){
      const wrap = document.createElement('div'); wrap.className='dl-item';

      const f1 = document.createElement('div');
      const l1 = document.createElement('label'); l1.textContent='Estado emisor';
      const s1 = stateSelect(); s1.required = true;
      f1.appendChild(l1); f1.appendChild(s1);

      const f2 = document.createElement('div');
      const l2 = document.createElement('label'); l2.textContent='Número de licencia';
      const t2 = document.createElement('input'); t2.type='text'; t2.name='US_DL_NUMBER'; t2.required = true; t2.maxLength=30;
      f2.appendChild(l2); f2.appendChild(t2);

      const f3 = document.createElement('div');
      const btn = document.createElement('button'); btn.type='button'; btn.className='remove'; btn.textContent='Eliminar';
      btn.addEventListener('click', ()=>{ dlList.removeChild(wrap); saveDlCount(); refreshDlRemove(); });
      f3.appendChild(btn);

      wrap.appendChild(f1); wrap.appendChild(f2); wrap.appendChild(f3);
      return wrap;
    }
    function refreshDlRemove(){
      const items = [...dlList.children];
      const hide = items.length <= 1;
      items.forEach(i => {
        const b = i.querySelector('button.remove'); if (b) b.style.visibility = hide ? 'hidden' : 'visible';
      });
    }
    function saveDlCount(){ localStorage.setItem(DL_COUNT_KEY, String(dlList.children.length)); }
    function addDl(){ const it = makeDlItem(); dlList.appendChild(it); saveDlCount(); refreshDlRemove(); }

    function updateTripsVisibility(){
      const show = prevTravelY.checked;
      tripsSection.classList.toggle('hide', !show);
      if (!show){
        tripsList.innerHTML = ""; saveTripCount();
        dlList.innerHTML = ""; saveDlCount();
        dlY.checked = dlN.checked = false; saveField(dlY); saveField(dlN);
        dlListBlock.classList.add('hide');
      } else {
        if (tripsList.children.length === 0) addTrip();
      }
    }
    function updateDlVisibility(){
      const show = dlY.checked;
      dlListBlock.classList.toggle('hide', !show);
      if (show && dlList.children.length === 0) addDl();
      if (!show){ dlList.innerHTML = ""; saveDlCount(); }
    }
    function updatePrevVisaVisibility(){
      const show = prevVisaY.checked;
      prevVisaBlock.classList.toggle('hide', !show);
      if (!show){
        // clear inner conditional blocks
        visaLostBlock.classList.add('hide');
        visaRevBlock.classList.add('hide');
      }
    }
    function updateLostVisibility(){
      const show = visaLostY && visaLostY.checked;
      visaLostBlock.classList.toggle('hide', !show);
    }
    function updateRevVisibility(){
      const show = visaRevY && visaRevY.checked;
      visaRevBlock.classList.toggle('hide', !show);
    }
    function updateRefusedVisibility(){
      const show = refusedY.checked;
      refusedBlock.classList.toggle('hide', !show);
    }
    function updateIvPetVisibility(){
      const show = ivPetY.checked;
      ivPetBlock.classList.toggle('hide', !show);
    }

    // Autosave
    autosave(form);

    // Restaurar radios y campos
    form.querySelectorAll('input[type="radio"]').forEach(restoreField);
    form.querySelectorAll('input[type="date"],input[type="text"],textarea,select').forEach(restoreField);

    // Inicializar selects de años
    ['VISA_LOST_YEAR','VISA_REVOKED_YEAR','REFUSED_YEAR','IV_PETITION_YEAR'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) fillYearSelect(el, 1980);
    });

    // Estado inicial tras restaurar
    updateTripsVisibility();
    updatePrevVisaVisibility();
    updateLostVisibility();
    updateRevVisibility();
    updateRefusedVisibility();
    updateIvPetVisibility();

    // Restaurar listas dinámicas
    if (!tripsSection.classList.contains('hide')){
      const n = Math.max(1, parseInt(localStorage.getItem(TRIP_COUNT_KEY) || '1', 10));
      for (let i=tripsList.children.length; i<n; i++) addTrip();
    }
    if (dlY.checked){
      const n = Math.max(1, parseInt(localStorage.getItem(DL_COUNT_KEY) || '1', 10));
      for (let i=dlList.children.length; i<n; i++) addDl();
      dlListBlock.classList.remove('hide');
    }

    // Listeners de cambio
    [prevTravelY, prevTravelN].forEach(r => r.addEventListener('change', ()=>{ saveField(r); updateTripsVisibility(); }));
    [dlY, dlN].forEach(r => r.addEventListener('change', ()=>{ saveField(r); updateDlVisibility(); }));
    [prevVisaY, prevVisaN].forEach(r => r.addEventListener('change', ()=>{ saveField(r); updatePrevVisaVisibility(); }));
    if (visaLostY && visaLostN){
      [visaLostY, visaLostN].forEach(r => r.addEventListener('change', ()=>{ saveField(r); updateLostVisibility(); }));
    }
    if (visaRevY && visaRevN){
      [visaRevY, visaRevN].forEach(r => r.addEventListener('change', ()=>{ saveField(r); updateRevVisibility(); }));
    }
    [refusedY, refusedN].forEach(r => r.addEventListener('change', ()=>{ saveField(r); updateRefusedVisibility(); }));
    [ivPetY, ivPetN].forEach(r => r.addEventListener('change', ()=>{ saveField(r); updateIvPetVisibility(); }));

    // Botones agregar
    addTripBtn.addEventListener('click', addTrip);
    addDlBtn.addEventListener('click', addDl);

    // Validación
    function checkForm(){
      // Si nunca estuvo en EE. UU. puede continuar sin secciones de viaje
      if (prevTravelY.checked){
        if (tripsList.children.length === 0){ addTrip(); }
      }
      return form.checkValidity();
    }

    // Navegación
    document.getElementById('backBtn').addEventListener('click', () => {
      form.querySelectorAll('input,select,textarea').forEach(saveField);
      window.location.assign(BACK_URL);
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (!checkForm()){
        form.reportValidity();
        const firstInvalid = form.querySelector(':invalid');
        if (firstInvalid) firstInvalid.scrollIntoView({behavior:'smooth', block:'center'});
        return;
      }
      form.querySelectorAll('input,select,textarea').forEach(saveField);
      window.location.assign(NEXT_URL);
    });
  </script>
</body>
</html>
